<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Exploring Thompsons Creek Stage Discharge Data</title>
  <meta name="description" content="Exploring Thompsons Creek Stage Discharge Data" />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="Exploring Thompsons Creek Stage Discharge Data" />
  <meta property="og:type" content="book" />
  
  
  
  <meta name="github-repo" content="https://github.com/mps9506/thompson-stage-discharge" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Exploring Thompsons Creek Stage Discharge Data" />
  
  
  



<meta name="date" content="2021-03-01" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  


<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">TEMPLATE</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path=""><a href="#about"><i class="fa fa-check"></i>About</a></li>
<li class="chapter" data-level="" data-path=""><a href="#introduction"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="" data-path=""><a href="#method"><i class="fa fa-check"></i>Method</a><ul>
<li class="chapter" data-level="" data-path=""><a href="#data-collection"><i class="fa fa-check"></i>Data collection</a></li>
<li class="chapter" data-level="" data-path=""><a href="#rating-curve-development"><i class="fa fa-check"></i>Rating curve development</a></li>
</ul></li>
<li class="chapter" data-level="" data-path=""><a href="#results"><i class="fa fa-check"></i>Results</a><ul>
<li class="chapter" data-level="" data-path=""><a href="#site-16396"><i class="fa fa-check"></i>Site 16396</a></li>
<li class="chapter" data-level="" data-path=""><a href="#site-16397"><i class="fa fa-check"></i>Site 16397</a></li>
<li class="chapter" data-level="" data-path=""><a href="#site-16882"><i class="fa fa-check"></i>Site 16882</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Exploring Thompsons Creek Stage Discharge Data</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="header">
<h1 class="title">Exploring Thompsons Creek Stage Discharge Data</h1>
<p class="date"><em>2021-03-01</em></p>
</div>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="co">## readr imports data</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="kw">library</span>(readr)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="co">## tibbles are advanced fancy dataframes</span></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="kw">library</span>(tibble)</span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="co">## dplyr for data handling and piping functions</span></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="kw">library</span>(dplyr)</span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="co">## ggplot for plots</span></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="kw">library</span>(ggplot2)</span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="co">## stringr to read and manipulate strings</span></span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="kw">library</span>(stringr)</span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="co">## here is a function to ensure file paths are correct</span></span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="kw">library</span>(here)</span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="co">## units and ggforce facilitate attaching units to data</span></span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="kw">library</span>(units)</span>
<span id="cb1-15"><a href="#cb1-15"></a><span class="kw">library</span>(ggforce)</span>
<span id="cb1-16"><a href="#cb1-16"></a><span class="co">## hrbrtheme is optional, I use it to pretty my plots</span></span>
<span id="cb1-17"><a href="#cb1-17"></a><span class="kw">library</span>(hrbrthemes)</span>
<span id="cb1-18"><a href="#cb1-18"></a><span class="co">## lubridate provides functions for handling time and date</span></span>
<span id="cb1-19"><a href="#cb1-19"></a><span class="kw">library</span>(lubridate)</span>
<span id="cb1-20"><a href="#cb1-20"></a><span class="co">## purrr lets us use map_ functions as an alternative to loops</span></span>
<span id="cb1-21"><a href="#cb1-21"></a><span class="kw">library</span>(purrr)</span>
<span id="cb1-22"><a href="#cb1-22"></a><span class="co">## hydroGOF provide goodness of fit metrics (NSE, RMSE, etc.)</span></span>
<span id="cb1-23"><a href="#cb1-23"></a><span class="kw">library</span>(hydroGOF)</span>
<span id="cb1-24"><a href="#cb1-24"></a><span class="co">## tsibble and imputeTS will allow some simple time series interpolation</span></span>
<span id="cb1-25"><a href="#cb1-25"></a><span class="kw">library</span>(tsibble)</span>
<span id="cb1-26"><a href="#cb1-26"></a><span class="kw">library</span>(imputeTS)</span>
<span id="cb1-27"><a href="#cb1-27"></a><span class="co">## gt</span></span>
<span id="cb1-28"><a href="#cb1-28"></a><span class="kw">library</span>(gtsummary)</span>
<span id="cb1-29"><a href="#cb1-29"></a><span class="co">## set some options</span></span>
<span id="cb1-30"><a href="#cb1-30"></a><span class="kw">update_geom_font_defaults</span>(font_rc)</span>
<span id="cb1-31"><a href="#cb1-31"></a><span class="kw">units_options</span>(<span class="dt">parse =</span> <span class="ot">FALSE</span>)</span>
<span id="cb1-32"><a href="#cb1-32"></a></span>
<span id="cb1-33"><a href="#cb1-33"></a></span>
<span id="cb1-34"><a href="#cb1-34"></a><span class="co">## some custom functions</span></span>
<span id="cb1-35"><a href="#cb1-35"></a>theme_ms &lt;-<span class="st"> </span><span class="cf">function</span>(...) {</span>
<span id="cb1-36"><a href="#cb1-36"></a>  <span class="kw">theme_ipsum_rc</span>(<span class="dt">plot_margin =</span> <span class="kw">margin</span>(<span class="dv">10</span>,<span class="dv">10</span>,<span class="dv">10</span>,<span class="dv">10</span>),</span>
<span id="cb1-37"><a href="#cb1-37"></a>              <span class="dt">axis_title_just =</span> <span class="st">&quot;c&quot;</span>) <span class="op">+</span></span>
<span id="cb1-38"><a href="#cb1-38"></a><span class="st">    </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span>,</span>
<span id="cb1-39"><a href="#cb1-39"></a>          <span class="dt">panel.background =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>, </span>
<span id="cb1-40"><a href="#cb1-40"></a>            <span class="dt">colour =</span> <span class="ot">NA</span>), </span>
<span id="cb1-41"><a href="#cb1-41"></a>          <span class="dt">panel.border =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="ot">NA</span>, </span>
<span id="cb1-42"><a href="#cb1-42"></a>            <span class="dt">colour =</span> <span class="st">&quot;grey20&quot;</span>),</span>
<span id="cb1-43"><a href="#cb1-43"></a>          ...)</span>
<span id="cb1-44"><a href="#cb1-44"></a>}</span>
<span id="cb1-45"><a href="#cb1-45"></a></span>
<span id="cb1-46"><a href="#cb1-46"></a>exponent &lt;-<span class="st"> </span><span class="cf">function</span>(x, pow) {</span>
<span id="cb1-47"><a href="#cb1-47"></a>  (<span class="kw">abs</span>(x)<span class="op">^</span>pow)<span class="op">*</span><span class="kw">sign</span>(x)</span>
<span id="cb1-48"><a href="#cb1-48"></a>}</span></code></pre></div>
<div id="about" class="section level2">
<h2>About</h2>
<p>This document walks through some exploratory data analysis to develop rating curves and streamflow predictions on Thompsons Creek. The purpose is to utilize (1) instantaneous streamflows measured during periodic deployments of bottom mounted doppler units and (2) instantaneous depth measurements from water level data loggers deployed long-term in-stream to create and update rating curves. The rating curves will be utilized to calculate streamflow over the HOBO pressure transducer deployment period (approximately 1-yr). The resulting data will be used to create and validate regression and DAR streamflow estimates in Thompsons creek over a 10-15 year period.</p>
</div>
<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>Due to the high costs associated with continuous in-stream measurements of stream discharge, it is preferable to estimate discharge using stream height measurements. Continuous measurements of stream height can be accomplished inexpensively using pressure transducers. When supplemented with periodic discharge measurements, a power function can relate stream height and discharge <span class="citation">(Venetis <a href="#ref-venetis1970note" role="doc-biblioref">1970</a>)</span>:</p>
<p><span class="math display" id="eq:powerfunction">\[\begin{equation}
  Q = K(H-H_0)^z
  \tag{1}
\end{equation}\]</span>
where:
<span class="math inline">\(Q\)</span> represents steady state discharge, <span class="math inline">\(H\)</span> represents stream height (stage), <span class="math inline">\(H_0\)</span> is the stage at zero discharge; <span class="math inline">\(K\)</span> and <span class="math inline">\(z\)</span> are rating curve constants.</p>
<p>Unsteady flows occur when the rising and falling stages of a stream hydrograph result in different discharges at identical stream heights. This resulting hysteresis-affected rating curve will present as a loop as opposed to a line. The modified Jones formula described by <span class="citation">Petersen-Øverleir (<a href="#ref-petersen-overleir_modelling_2006" role="doc-biblioref">2006</a>)</span> and <span class="citation">Zakwan (<a href="#ref-zakwan_spreadsheet-based_2018" role="doc-biblioref">2018</a>)</span> may be used:</p>
<p><span class="math display" id="eq:Jonesformula">\[\begin{equation}
  Q = K(h-a)^n\times\sqrt{1 + x\frac{\partial h}{\partial t}}
  \tag{2}
\end{equation}\]</span></p>
<p>where:
<span class="math inline">\(Q\)</span> is discharge, <span class="math inline">\(h\)</span> is stream height, and <span class="math inline">\(\frac{\partial h}{\partial t}\)</span> is the partial first order derivative approximated using finite differences. This can be considered the slope or instantaneous rate of change for the function between stream height and time which is estimated using measured stream height values. <span class="math inline">\(K\)</span>, <span class="math inline">\(a\)</span>, <span class="math inline">\(n\)</span>, and <span class="math inline">\(x\)</span> are rating curve constants.</p>
<p>A number of different methods are available to solve for the rating curve parameters. We use a quasi-Newton optimization method to minimize the residual sum of square error (SSE) of the rating curve parameters. The residual SSE is calculated as:</p>
<p><span class="math display" id="eq:sseformula">\[\begin{equation}
SSE = \sum\limits_{i=1}^N[X-Y]^2
  \tag{3}
\end{equation}\]</span></p>
<p>where:
<span class="math inline">\(X\)</span> is the measured value and <span class="math inline">\(Y\)</span> is the predicted value. Nonlinear optimization methods, such as quasi-Newton optimization, search though parameter combinations to minimize the objective function (residual SSE in this case).</p>
</div>
<div id="method" class="section level2">
<h2>Method</h2>
<div id="data-collection" class="section level3">
<h3>Data collection</h3>
<p>Water level data loggers (HOBO U20 Series Water Level Data Loggers) were deployed at TCEQ SWQM stations 16396, 16397, and 16882. An additional data logger was deployed at … to provide ambient atmospheric pressure corrections for the data loggers deployed underwater. Water level data loggers were deployed near continuously from 2020-03-02 through 2021-..-… and setup to record water level at 15-minute intervals.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co">## make a list of files to import</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>file_paths &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="kw">here</span>(<span class="st">&quot;Data/Hobo&quot;</span>),</span>
<span id="cb2-3"><a href="#cb2-3"></a>                     <span class="st">&quot;/&quot;</span>,</span>
<span id="cb2-4"><a href="#cb2-4"></a>                     <span class="kw">list.files</span>(<span class="dt">path =</span> <span class="kw">here</span>(<span class="st">&quot;Data/Hobo&quot;</span>),</span>
<span id="cb2-5"><a href="#cb2-5"></a>                                <span class="dt">pattern =</span> <span class="st">&quot;.csv&quot;</span>))</span>
<span id="cb2-6"><a href="#cb2-6"></a></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="co">## create a blank tibble to fill</span></span>
<span id="cb2-8"><a href="#cb2-8"></a>hobo_df &lt;-<span class="st"> </span><span class="kw">tibble</span>()</span>
<span id="cb2-9"><a href="#cb2-9"></a></span>
<span id="cb2-10"><a href="#cb2-10"></a></span>
<span id="cb2-11"><a href="#cb2-11"></a><span class="co">## loop through file paths to read each file</span></span>
<span id="cb2-12"><a href="#cb2-12"></a><span class="cf">for</span> (i <span class="cf">in</span> file_paths) {</span>
<span id="cb2-13"><a href="#cb2-13"></a>  x &lt;-<span class="st"> </span><span class="kw">read_csv</span>(</span>
<span id="cb2-14"><a href="#cb2-14"></a>    i,</span>
<span id="cb2-15"><a href="#cb2-15"></a>    <span class="dt">skip =</span> <span class="dv">2</span>,</span>
<span id="cb2-16"><a href="#cb2-16"></a>    <span class="dt">col_names =</span> <span class="kw">c</span>(</span>
<span id="cb2-17"><a href="#cb2-17"></a>      <span class="st">&quot;Row&quot;</span>,</span>
<span id="cb2-18"><a href="#cb2-18"></a>      <span class="st">&quot;Date&quot;</span>,</span>
<span id="cb2-19"><a href="#cb2-19"></a>      <span class="st">&quot;Time&quot;</span>,</span>
<span id="cb2-20"><a href="#cb2-20"></a>      <span class="st">&quot;Abs_Pres&quot;</span>,</span>
<span id="cb2-21"><a href="#cb2-21"></a>      <span class="st">&quot;Temp&quot;</span>,</span>
<span id="cb2-22"><a href="#cb2-22"></a>      <span class="st">&quot;Bar_Pressure&quot;</span>,</span>
<span id="cb2-23"><a href="#cb2-23"></a>      <span class="st">&quot;Water_Level&quot;</span>,</span>
<span id="cb2-24"><a href="#cb2-24"></a>      <span class="st">&quot;Coupler_Detached&quot;</span>,</span>
<span id="cb2-25"><a href="#cb2-25"></a>      <span class="st">&quot;Coupler_Attached&quot;</span>,</span>
<span id="cb2-26"><a href="#cb2-26"></a>      <span class="st">&quot;Stopped&quot;</span>,</span>
<span id="cb2-27"><a href="#cb2-27"></a>      <span class="st">&quot;EOF&quot;</span></span>
<span id="cb2-28"><a href="#cb2-28"></a>    ),</span>
<span id="cb2-29"><a href="#cb2-29"></a>    <span class="dt">col_types =</span> <span class="st">&quot;nccnnnncccc&quot;</span></span>
<span id="cb2-30"><a href="#cb2-30"></a>  )</span>
<span id="cb2-31"><a href="#cb2-31"></a>  x<span class="op">$</span>file &lt;-<span class="st"> </span>i</span>
<span id="cb2-32"><a href="#cb2-32"></a>  hobo_df &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(hobo_df, x)</span>
<span id="cb2-33"><a href="#cb2-33"></a>  <span class="kw">rm</span>(x)</span>
<span id="cb2-34"><a href="#cb2-34"></a>}</span>
<span id="cb2-35"><a href="#cb2-35"></a></span>
<span id="cb2-36"><a href="#cb2-36"></a><span class="co">## clean up the dataframe</span></span>
<span id="cb2-37"><a href="#cb2-37"></a>hobo_df &lt;-<span class="st"> </span>hobo_df <span class="op">%&gt;%</span></span>
<span id="cb2-38"><a href="#cb2-38"></a><span class="st">  </span><span class="kw">mutate</span>(</span>
<span id="cb2-39"><a href="#cb2-39"></a>    <span class="co">## regex extracts site number from file path</span></span>
<span id="cb2-40"><a href="#cb2-40"></a>    <span class="dt">Site =</span> <span class="kw">str_extract</span>(file, <span class="st">&quot;</span><span class="ch">\\</span><span class="st">d{1,6}&quot;</span>),</span>
<span id="cb2-41"><a href="#cb2-41"></a>    </span>
<span id="cb2-42"><a href="#cb2-42"></a>    <span class="co">## convert date and time columns to date/time format</span></span>
<span id="cb2-43"><a href="#cb2-43"></a>    <span class="dt">dt =</span> <span class="kw">paste</span>(Date, Time),</span>
<span id="cb2-44"><a href="#cb2-44"></a>    <span class="dt">Date_Time =</span> <span class="kw">as.POSIXct</span>(<span class="kw">paste</span>(Date, Time),</span>
<span id="cb2-45"><a href="#cb2-45"></a>                           <span class="dt">tz =</span> <span class="st">&quot;Etc/GMT-6&quot;</span>,</span>
<span id="cb2-46"><a href="#cb2-46"></a>                           <span class="dt">format =</span> <span class="st">&quot;%m/%d/%y %I:%M:%S %p&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb2-47"><a href="#cb2-47"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Site =</span> <span class="kw">as.factor</span>(Site)) <span class="op">%&gt;%</span></span>
<span id="cb2-48"><a href="#cb2-48"></a><span class="st">  </span><span class="co">## select the columns we need to keep</span></span>
<span id="cb2-49"><a href="#cb2-49"></a><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">select</span>(Abs_Pres, Temp, Water_Level, Site, Date_Time) <span class="op">%&gt;%</span></span>
<span id="cb2-50"><a href="#cb2-50"></a><span class="st">  </span><span class="co">## filter rows without water_level</span></span>
<span id="cb2-51"><a href="#cb2-51"></a><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(Water_Level))</span>
<span id="cb2-52"><a href="#cb2-52"></a>  </span>
<span id="cb2-53"><a href="#cb2-53"></a><span class="co">## attach units to our columns</span></span>
<span id="cb2-54"><a href="#cb2-54"></a><span class="kw">units</span>(hobo_df<span class="op">$</span>Water_Level) &lt;-<span class="st"> </span><span class="kw">as_units</span>(<span class="st">&quot;ft&quot;</span>)</span>
<span id="cb2-55"><a href="#cb2-55"></a><span class="kw">units</span>(hobo_df<span class="op">$</span>Temp) &lt;-<span class="st"> </span><span class="kw">as_units</span>(<span class="st">&quot;°F&quot;</span>)</span>
<span id="cb2-56"><a href="#cb2-56"></a><span class="kw">units</span>(hobo_df<span class="op">$</span>Abs_Pres) &lt;-<span class="st"> </span><span class="kw">as_units</span>(<span class="st">&quot;psi&quot;</span>)</span>
<span id="cb2-57"><a href="#cb2-57"></a></span>
<span id="cb2-58"><a href="#cb2-58"></a><span class="co">## report summary stats</span></span>
<span id="cb2-59"><a href="#cb2-59"></a>hobo_df <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb2-60"><a href="#cb2-60"></a><span class="st">  </span><span class="kw">select</span>(Site, Water_Level) <span class="op">%&gt;%</span></span>
<span id="cb2-61"><a href="#cb2-61"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Water_Level =</span> <span class="kw">as.numeric</span>(Water_Level)) <span class="op">%&gt;%</span></span>
<span id="cb2-62"><a href="#cb2-62"></a><span class="st">  </span><span class="kw">tbl_summary</span>(<span class="dt">by =</span> Site) <span class="op">%&gt;%</span></span>
<span id="cb2-63"><a href="#cb2-63"></a><span class="st">  </span><span class="kw">add_n</span>() <span class="op">%&gt;%</span></span>
<span id="cb2-64"><a href="#cb2-64"></a><span class="st">  </span><span class="kw">modify_header</span>(<span class="dt">label =</span> <span class="st">&quot;**Variable**&quot;</span>)</span></code></pre></div>
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#bqjsjzjjys .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#bqjsjzjjys .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#bqjsjzjjys .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#bqjsjzjjys .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 4px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#bqjsjzjjys .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#bqjsjzjjys .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#bqjsjzjjys .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#bqjsjzjjys .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#bqjsjzjjys .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#bqjsjzjjys .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#bqjsjzjjys .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#bqjsjzjjys .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#bqjsjzjjys .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#bqjsjzjjys .gt_from_md > :first-child {
  margin-top: 0;
}

#bqjsjzjjys .gt_from_md > :last-child {
  margin-bottom: 0;
}

#bqjsjzjjys .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#bqjsjzjjys .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#bqjsjzjjys .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#bqjsjzjjys .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#bqjsjzjjys .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#bqjsjzjjys .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#bqjsjzjjys .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#bqjsjzjjys .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#bqjsjzjjys .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#bqjsjzjjys .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#bqjsjzjjys .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#bqjsjzjjys .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#bqjsjzjjys .gt_left {
  text-align: left;
}

#bqjsjzjjys .gt_center {
  text-align: center;
}

#bqjsjzjjys .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#bqjsjzjjys .gt_font_normal {
  font-weight: normal;
}

#bqjsjzjjys .gt_font_bold {
  font-weight: bold;
}

#bqjsjzjjys .gt_font_italic {
  font-style: italic;
}

#bqjsjzjjys .gt_super {
  font-size: 65%;
}

#bqjsjzjjys .gt_footnote_marks {
  font-style: italic;
  font-size: 65%;
}
</style>
<div id="bqjsjzjjys" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;"><table class="gt_table">
  
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1"><strong>Variable</strong></th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1"><strong>N</strong></th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1"><strong>16396</strong>, N = 29,821<sup class="gt_footnote_marks">1</sup></th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1"><strong>16397</strong>, N = 29,823<sup class="gt_footnote_marks">1</sup></th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1"><strong>16882</strong>, N = 30,505<sup class="gt_footnote_marks">1</sup></th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr>
      <td class="gt_row gt_left">Water_Level</td>
      <td class="gt_row gt_center">90,149</td>
      <td class="gt_row gt_center">1.72 (1.66, 1.82)</td>
      <td class="gt_row gt_center">1.42 (1.06, 1.79)</td>
      <td class="gt_row gt_center">2.39 (2.35, 2.44)</td>
    </tr>
  </tbody>
  
  <tfoot>
    <tr class="gt_footnotes">
      <td colspan="5">
        <p class="gt_footnote">
          <sup class="gt_footnote_marks">
            <em>1</em>
          </sup>
           
          Median (IQR)
          <br />
        </p>
      </td>
    </tr>
  </tfoot>
</table></div>
<p>Periodic streamflow measurements were made at each SWQM site using a bottom-mounted multi-beam Doppler flow meter (Son-Tek IQ Plus). The Son-Tek IQ Plus measures cross sectional area, stream height, and velocity. Using these measurements, the device utilizes an index velocity method to report instantaneous discharge. The streamflow measurement device were deployed for a few days at a time to capture the full hydrograph under varying flow conditions at each SWQM station. Only one streamflow device was available, so deployments rotated between stations. Streamflow was recorded at 15-minute intervals.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="co">## make a list of files to import</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>file_paths &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="kw">here</span>(<span class="st">&quot;Data/IQPlus&quot;</span>),</span>
<span id="cb3-3"><a href="#cb3-3"></a>                     <span class="st">&quot;/&quot;</span>,</span>
<span id="cb3-4"><a href="#cb3-4"></a>                     <span class="kw">list.files</span>(<span class="dt">path =</span> <span class="kw">here</span>(<span class="st">&quot;Data/IQPlus&quot;</span>),</span>
<span id="cb3-5"><a href="#cb3-5"></a>                                <span class="dt">pattern =</span> <span class="st">&quot;.csv&quot;</span>))</span>
<span id="cb3-6"><a href="#cb3-6"></a></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="co">## create a blank tibble to fill</span></span>
<span id="cb3-8"><a href="#cb3-8"></a>iqplus_df &lt;-<span class="st"> </span><span class="kw">tibble</span>()</span>
<span id="cb3-9"><a href="#cb3-9"></a></span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="co">## loop through file paths to read each file</span></span>
<span id="cb3-11"><a href="#cb3-11"></a><span class="cf">for</span> (i <span class="cf">in</span> file_paths) {</span>
<span id="cb3-12"><a href="#cb3-12"></a>  x &lt;-<span class="st"> </span><span class="kw">read_csv</span>(</span>
<span id="cb3-13"><a href="#cb3-13"></a>    i,</span>
<span id="cb3-14"><a href="#cb3-14"></a>    <span class="dt">col_types =</span> <span class="st">&quot;nc______n__n______________________nn______n_________&quot;</span></span>
<span id="cb3-15"><a href="#cb3-15"></a>  )</span>
<span id="cb3-16"><a href="#cb3-16"></a>  x<span class="op">$</span>file &lt;-<span class="st"> </span>i</span>
<span id="cb3-17"><a href="#cb3-17"></a>  iqplus_df &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(iqplus_df, x)</span>
<span id="cb3-18"><a href="#cb3-18"></a>  <span class="kw">rm</span>(x)</span>
<span id="cb3-19"><a href="#cb3-19"></a>}</span>
<span id="cb3-20"><a href="#cb3-20"></a></span>
<span id="cb3-21"><a href="#cb3-21"></a></span>
<span id="cb3-22"><a href="#cb3-22"></a>iqplus_df &lt;-<span class="st"> </span>iqplus_df <span class="op">%&gt;%</span></span>
<span id="cb3-23"><a href="#cb3-23"></a><span class="st">    </span><span class="kw">mutate</span>(</span>
<span id="cb3-24"><a href="#cb3-24"></a>    <span class="co">## regex extracts site number from file path</span></span>
<span id="cb3-25"><a href="#cb3-25"></a>    <span class="dt">Site =</span> <span class="kw">str_extract</span>(file, <span class="st">&quot;</span><span class="ch">\\</span><span class="st">d{1,6}&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb3-26"><a href="#cb3-26"></a><span class="st">  </span><span class="co">## use `dplyr::` to specify which rename function to use, just in case</span></span>
<span id="cb3-27"><a href="#cb3-27"></a><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">rename</span>(<span class="dt">Sample_Number =</span><span class="st">`</span><span class="dt">Sample number</span><span class="st">`</span>,</span>
<span id="cb3-28"><a href="#cb3-28"></a>                <span class="dt">Date_Time =</span> <span class="st">`</span><span class="dt">Sample time</span><span class="st">`</span>,</span>
<span id="cb3-29"><a href="#cb3-29"></a>                <span class="dt">Depth =</span> <span class="st">`</span><span class="dt">Depth (ft)</span><span class="st">`</span>,</span>
<span id="cb3-30"><a href="#cb3-30"></a>                <span class="dt">Flow =</span> <span class="st">`</span><span class="dt">Flow (ft³/s)</span><span class="st">`</span>,</span>
<span id="cb3-31"><a href="#cb3-31"></a>                <span class="dt">System_In_Water =</span> <span class="st">`</span><span class="dt">System in water (%)</span><span class="st">`</span>,</span>
<span id="cb3-32"><a href="#cb3-32"></a>                <span class="dt">System_Status =</span> <span class="st">`</span><span class="dt">System status (status codes)</span><span class="st">`</span>,</span>
<span id="cb3-33"><a href="#cb3-33"></a>                <span class="dt">Index_Velocity =</span> <span class="st">`</span><span class="dt">Velocity (mean) (ft/s)</span><span class="st">`</span>) <span class="op">%&gt;%</span></span>
<span id="cb3-34"><a href="#cb3-34"></a><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">select</span>(<span class="op">-</span><span class="kw">c</span>(Sample_Number, file)) <span class="op">%&gt;%</span></span>
<span id="cb3-35"><a href="#cb3-35"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Date_Time =</span> <span class="kw">as.POSIXct</span>(Date_Time,</span>
<span id="cb3-36"><a href="#cb3-36"></a>                                <span class="dt">tz =</span> <span class="st">&quot;Etc/GMT-6&quot;</span>,</span>
<span id="cb3-37"><a href="#cb3-37"></a>                                <span class="dt">format =</span> <span class="st">&quot;%Y-%m-%d %H:%M:%S&quot;</span>))</span>
<span id="cb3-38"><a href="#cb3-38"></a></span>
<span id="cb3-39"><a href="#cb3-39"></a></span>
<span id="cb3-40"><a href="#cb3-40"></a><span class="co">## attach units to our columns</span></span>
<span id="cb3-41"><a href="#cb3-41"></a><span class="kw">units</span>(iqplus_df<span class="op">$</span>Depth) &lt;-<span class="st"> </span><span class="kw">as_units</span>(<span class="st">&quot;ft&quot;</span>)</span>
<span id="cb3-42"><a href="#cb3-42"></a><span class="kw">units</span>(iqplus_df<span class="op">$</span>Flow) &lt;-<span class="st"> </span><span class="kw">as_units</span>(<span class="st">&quot;ft^3/s&quot;</span>)</span>
<span id="cb3-43"><a href="#cb3-43"></a><span class="kw">units</span>(iqplus_df<span class="op">$</span>Index_Velocity) &lt;-<span class="st"> </span><span class="kw">as_units</span>(<span class="st">&quot;ft/s&quot;</span>)</span>
<span id="cb3-44"><a href="#cb3-44"></a></span>
<span id="cb3-45"><a href="#cb3-45"></a><span class="co">## some data cleaning</span></span>
<span id="cb3-46"><a href="#cb3-46"></a>iqplus_df <span class="op">%&gt;%</span></span>
<span id="cb3-47"><a href="#cb3-47"></a><span class="st">  </span><span class="kw">filter</span>(System_Status <span class="op">==</span><span class="st"> </span><span class="dv">0</span>,</span>
<span id="cb3-48"><a href="#cb3-48"></a>         System_In_Water <span class="op">==</span><span class="st"> </span><span class="dv">100</span>,</span>
<span id="cb3-49"><a href="#cb3-49"></a>         <span class="kw">as.numeric</span>(Depth) <span class="op">&gt;=</span><span class="st"> </span><span class="fl">0.26</span>, <span class="co">## minimum operating depth</span></span>
<span id="cb3-50"><a href="#cb3-50"></a>         <span class="kw">as.numeric</span>(Flow) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) -&gt;<span class="st"> </span>iqplus_df</span>
<span id="cb3-51"><a href="#cb3-51"></a></span>
<span id="cb3-52"><a href="#cb3-52"></a><span class="kw">ggplot</span>(iqplus_df) <span class="op">+</span></span>
<span id="cb3-53"><a href="#cb3-53"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(Date_Time, Flow)) <span class="op">+</span></span>
<span id="cb3-54"><a href="#cb3-54"></a><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>Site, <span class="dt">ncol =</span> <span class="dv">1</span>, <span class="dt">scales =</span> <span class="st">&quot;free_y&quot;</span>) <span class="op">+</span></span>
<span id="cb3-55"><a href="#cb3-55"></a><span class="st">  </span><span class="kw">theme_ms</span>()</span></code></pre></div>
<p><img src="document_files/figure-html/iqimport-1.png" width="672" /></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="co">## In order to join the hobo measured depth to the IQ streamflow measurements</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="co">## we need to interpolate measured Depth to every minute because the depths are</span></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="co">## offset. Then we can join the data. we will use linear interpolation.</span></span>
<span id="cb4-4"><a href="#cb4-4"></a></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="co">## I need a pipe friendly function that assigns an attribute to </span></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="co">## a tibble (tsibble) and returns a tibble (tsibble)</span></span>
<span id="cb4-7"><a href="#cb4-7"></a>pipe_attr &lt;-<span class="st"> </span><span class="cf">function</span>(df) {</span>
<span id="cb4-8"><a href="#cb4-8"></a>  <span class="kw">attr</span>(df, <span class="st">&quot;interval&quot;</span>) &lt;-<span class="st"> </span><span class="kw">new_interval</span>(<span class="dt">minute =</span> <span class="dv">1</span>)</span>
<span id="cb4-9"><a href="#cb4-9"></a>  <span class="kw">return</span>(df)</span>
<span id="cb4-10"><a href="#cb4-10"></a>}</span>
<span id="cb4-11"><a href="#cb4-11"></a></span>
<span id="cb4-12"><a href="#cb4-12"></a><span class="co">## use purrr::map to run interpolation on each site</span></span>
<span id="cb4-13"><a href="#cb4-13"></a>hobo_df <span class="op">%&gt;%</span></span>
<span id="cb4-14"><a href="#cb4-14"></a><span class="st">  </span><span class="kw">split</span>(.<span class="op">$</span>Site) <span class="op">%&gt;%</span></span>
<span id="cb4-15"><a href="#cb4-15"></a><span class="st">  </span><span class="kw">map</span>(<span class="op">~</span>dplyr<span class="op">::</span><span class="kw">mutate</span>(.x, <span class="dt">Date_Time =</span> <span class="kw">round_date</span>(.x<span class="op">$</span>Date_Time, <span class="dt">unit =</span> <span class="st">&quot;minute&quot;</span>))) <span class="op">%&gt;%</span></span>
<span id="cb4-16"><a href="#cb4-16"></a><span class="st">  </span><span class="kw">map</span>(<span class="op">~</span><span class="kw">as_tsibble</span>(.x, <span class="dt">key =</span> Site, <span class="dt">index =</span> Date_Time)) <span class="op">%&gt;%</span></span>
<span id="cb4-17"><a href="#cb4-17"></a><span class="st">  </span><span class="kw">map</span>(<span class="op">~</span><span class="kw">pipe_attr</span>(.x)) <span class="op">%&gt;%</span></span>
<span id="cb4-18"><a href="#cb4-18"></a><span class="st">  </span><span class="kw">map</span>(<span class="op">~</span><span class="kw">fill_gaps</span>(.x)) <span class="op">%&gt;%</span></span>
<span id="cb4-19"><a href="#cb4-19"></a><span class="st">  </span><span class="kw">map</span>(<span class="op">~</span><span class="kw">mutate</span>(.x, <span class="dt">Water_Level =</span> <span class="kw">na_interpolation</span>(<span class="kw">as.numeric</span>(Water_Level), <span class="dt">option =</span> <span class="st">&quot;linear&quot;</span>))) <span class="op">%&gt;%</span></span>
<span id="cb4-20"><a href="#cb4-20"></a><span class="st">  </span><span class="kw">bind_rows</span>() <span class="op">%&gt;%</span></span>
<span id="cb4-21"><a href="#cb4-21"></a><span class="st">  </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span></span>
<span id="cb4-22"><a href="#cb4-22"></a><span class="st">  </span><span class="kw">select</span>(Water_Level, Site, Date_Time) -&gt;<span class="st"> </span>hobo_df_interpolated</span>
<span id="cb4-23"><a href="#cb4-23"></a></span>
<span id="cb4-24"><a href="#cb4-24"></a><span class="co">## replace Depth in iqplus_df with Water_Level reading from Hobo</span></span>
<span id="cb4-25"><a href="#cb4-25"></a><span class="co">## this is the dataframe we will develop rating curves from.</span></span>
<span id="cb4-26"><a href="#cb4-26"></a>iqplus_df <span class="op">%&gt;%</span></span>
<span id="cb4-27"><a href="#cb4-27"></a><span class="st">  </span><span class="kw">left_join</span>(hobo_df_interpolated, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;Site&quot;</span> =<span class="st"> &quot;Site&quot;</span>, <span class="st">&quot;Date_Time&quot;</span> =<span class="st"> &quot;Date_Time&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb4-28"><a href="#cb4-28"></a><span class="st">  </span><span class="kw">select</span>(Date_Time, Flow, System_In_Water, System_Status, Site, Water_Level) <span class="op">%&gt;%</span></span>
<span id="cb4-29"><a href="#cb4-29"></a><span class="st">  </span><span class="kw">rename</span>(<span class="dt">Depth =</span> Water_Level) <span class="op">%&gt;%</span></span>
<span id="cb4-30"><a href="#cb4-30"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Depth =</span> <span class="kw">set_units</span>(Depth, <span class="st">&quot;ft&quot;</span>)) -&gt;<span class="st"> </span>iqplus_df</span></code></pre></div>
</div>
<div id="rating-curve-development" class="section level3">
<h3>Rating curve development</h3>
<p>In-stream and stream bank conditions change through the year due to plant growth, plant dieback, sedimentation, erosion, and other processes. These changing conditions can necessitate the development of multiple rating curves. Exploratory data analysis was used to identify periods of change and the potential for hysteresis affected rating curves. Once rating curve periods and appropriate formulas were determined, rating curve parameters in formulas <a href="#eq:powerfunction">(1)</a> and <a href="#eq:Jonesformula">(2)</a> were estimated using the <code>optim</code> function in <code>R</code> by minimizing the residual SSE.</p>
<p>Individual rating curves were used to estimate streamflows using the measured stream heights. Nash-Sutcliffe Efficiency (NSE) and normalized Root Mean Square Error was used to evaluate goodness-of-fit between measured and estimated streamflow. NSE is a normalized statistic that evaluates the relative residual variance against the measured data variance and is calculated as:</p>
<p><span class="math display" id="eq:nseformula">\[\begin{equation}
NSE = 1 - \frac{\sum\limits_{t=1}^T(Q^t_{sim}-Q^t_{obs})^2}{\sum\limits_{t=1}^T(Q^t_{obs}-\bar{Q}_{obs})^2}
  \tag{4}
\end{equation}\]</span></p>
<p>Where <span class="math inline">\(\bar{Q}_{obs}\)</span> is the mean of observed discharges, <span class="math inline">\(Q^t_{sim}\)</span> is the estimated discharge at time <span class="math inline">\(t\)</span>, and <span class="math inline">\(Q^t_{obs}\)</span> is observed discharge at time <span class="math inline">\(t\)</span>. Values of NSE range from <span class="math inline">\(-\infty\)</span> to 1, where 1 indicates perfect predicitive performance. NSE of zero indicates the model has the same predictive performance as the mean of the dataset.</p>
<p>The nRMSE is a percentage based metric that describes the difference between predicted and measured discharge values:</p>
<p><span class="math display" id="eq:nRMSE">\[\begin{equation}
nRMSE = \frac{RMSE}{Q_{max}-Q_{min}}, \quad \textrm{where} \quad RMSE = \sqrt{\frac{\sum_{t=1}^{n}{(Q_t-\hat{Q}_t)^2}}{n}}
  \tag{5}
\end{equation}\]</span></p>
<p>Where <span class="math inline">\(Q_i\)</span> is the observed discharge at time <span class="math inline">\(t\)</span>, <span class="math inline">\(\hat{Q}_t\)</span> is the estimated discharge at time <span class="math inline">\(t\)</span>, <span class="math inline">\(n\)</span> is the number of samples, <span class="math inline">\(Q_max\)</span> and <span class="math inline">\(Q_min\)</span> are the maximum and minimum observed discharges. The resulting nRMSE calculation is a percentage value.</p>
</div>
</div>
<div id="results" class="section level2">
<h2>Results</h2>
<div id="site-16396" class="section level3">
<h3>Site 16396</h3>
<p>Based on exploratory analysis, two rating curves were developed for site 16396. The rating curve periods were 2020-03-03 through 2020-11-30 and 2020-12-01 through 2021-01-31. Due to apparent unsteady flow in the observed hydrogaphs, we applied the Jones formula (Formaula<a href="#eq:Jonesformula">(2)</a>). Both time periods resulted in a rating curve with NSE greater than 0.97 and nRMSE less than 2% indicating excellent fit (Table <a href="#tab:results16369">1</a>; Figure <a href="#fig:metricplot16396">1</a>).</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="co">## Make dataframe for site 16396 before december </span></span>
<span id="cb5-2"><a href="#cb5-2"></a></span>
<span id="cb5-3"><a href="#cb5-3"></a>iqplus_df <span class="op">%&gt;%</span></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="st">  </span><span class="kw">filter</span>(Site <span class="op">==</span><span class="st"> &quot;16396&quot;</span>,</span>
<span id="cb5-5"><a href="#cb5-5"></a>         System_Status <span class="op">==</span><span class="st"> </span><span class="dv">0</span>,</span>
<span id="cb5-6"><a href="#cb5-6"></a>         System_In_Water <span class="op">==</span><span class="st"> </span><span class="dv">100</span>,</span>
<span id="cb5-7"><a href="#cb5-7"></a>         <span class="kw">as.numeric</span>(Depth) <span class="op">&gt;=</span><span class="st"> </span><span class="fl">0.26</span>, <span class="co">## minimum operating depth</span></span>
<span id="cb5-8"><a href="#cb5-8"></a>         <span class="kw">as.numeric</span>(Flow) <span class="op">&gt;=</span><span class="st"> </span><span class="dv">0</span>,</span>
<span id="cb5-9"><a href="#cb5-9"></a>         Date_Time <span class="op">&lt;</span><span class="st"> </span><span class="kw">as.Date</span>(<span class="st">&quot;2020-12-01&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="st">  </span><span class="kw">arrange</span>(Date_Time) <span class="op">%&gt;%</span></span>
<span id="cb5-11"><a href="#cb5-11"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">time_lag =</span> <span class="kw">lag</span>(Date_Time, <span class="dt">default =</span> Date_Time[<span class="dv">1</span>]),</span>
<span id="cb5-12"><a href="#cb5-12"></a>         <span class="dt">diff_time =</span> <span class="kw">as.numeric</span>(<span class="kw">difftime</span>(Date_Time, time_lag, <span class="dt">units =</span> <span class="st">&quot;hours&quot;</span>))) <span class="op">%&gt;%</span></span>
<span id="cb5-13"><a href="#cb5-13"></a><span class="st">  </span><span class="kw">group_split</span>(<span class="kw">cumsum</span>(diff_time <span class="op">&gt;</span><span class="st"> </span><span class="dv">8</span>)) <span class="op">%&gt;%</span></span>
<span id="cb5-14"><a href="#cb5-14"></a><span class="st">  </span><span class="co">## remove events where max flow did not go over 10 cfs</span></span>
<span id="cb5-15"><a href="#cb5-15"></a><span class="st">  </span><span class="kw">keep</span>(<span class="op">~</span><span class="st"> </span><span class="kw">max</span>(<span class="kw">as.numeric</span>(.x<span class="op">$</span>Flow)) <span class="op">&gt;</span><span class="st"> </span><span class="dv">10</span>) <span class="op">%&gt;%</span></span>
<span id="cb5-16"><a href="#cb5-16"></a><span class="st">  </span><span class="kw">map</span>(<span class="op">~</span><span class="kw">select</span>(.x, Date_Time, Depth, Flow)) <span class="op">%&gt;%</span></span>
<span id="cb5-17"><a href="#cb5-17"></a><span class="st">  </span><span class="kw">map</span>(<span class="op">~</span><span class="kw">mutate</span>(.x,</span>
<span id="cb5-18"><a href="#cb5-18"></a>              <span class="dt">time_lag =</span> <span class="kw">lag</span>(Date_Time, <span class="dt">default =</span> Date_Time[<span class="dv">1</span>]),</span>
<span id="cb5-19"><a href="#cb5-19"></a>              <span class="dt">diff_time =</span> <span class="kw">as.numeric</span>(<span class="kw">difftime</span>(Date_Time, time_lag, <span class="dt">units =</span> <span class="st">&quot;hours&quot;</span>)),</span>
<span id="cb5-20"><a href="#cb5-20"></a>              <span class="dt">diff_depth =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">diff</span>(.x<span class="op">$</span>Depth)))) <span class="op">%&gt;%</span></span>
<span id="cb5-21"><a href="#cb5-21"></a><span class="st">  </span><span class="kw">imap</span>(<span class="op">~</span><span class="kw">mutate</span>(.x, <span class="dt">event =</span> <span class="kw">as.character</span>(.y))) <span class="op">%&gt;%</span></span>
<span id="cb5-22"><a href="#cb5-22"></a><span class="st">  </span><span class="kw">bind_rows</span>() <span class="op">%&gt;%</span></span>
<span id="cb5-23"><a href="#cb5-23"></a><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(diff_depth)) <span class="op">%&gt;%</span></span>
<span id="cb5-24"><a href="#cb5-24"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">J =</span> <span class="kw">as.numeric</span>(diff_depth)<span class="op">/</span><span class="kw">as.numeric</span>(diff_time)) -&gt;<span class="st"> </span>df_<span class="dv">16396</span>_<span class="dv">2020</span>_<span class="dv">12</span></span>
<span id="cb5-25"><a href="#cb5-25"></a></span>
<span id="cb5-26"><a href="#cb5-26"></a>iqplus_df <span class="op">%&gt;%</span></span>
<span id="cb5-27"><a href="#cb5-27"></a><span class="st">  </span><span class="kw">filter</span>(Site <span class="op">==</span><span class="st"> &quot;16396&quot;</span>,</span>
<span id="cb5-28"><a href="#cb5-28"></a>         System_Status <span class="op">==</span><span class="st"> </span><span class="dv">0</span>,</span>
<span id="cb5-29"><a href="#cb5-29"></a>         System_In_Water <span class="op">==</span><span class="st"> </span><span class="dv">100</span>,</span>
<span id="cb5-30"><a href="#cb5-30"></a>         <span class="kw">as.numeric</span>(Depth) <span class="op">&gt;=</span><span class="st"> </span><span class="fl">0.26</span>, <span class="co">## minimum operating depth</span></span>
<span id="cb5-31"><a href="#cb5-31"></a>         <span class="kw">as.numeric</span>(Flow) <span class="op">&gt;=</span><span class="st"> </span><span class="dv">0</span>,</span>
<span id="cb5-32"><a href="#cb5-32"></a>         Date_Time <span class="op">&gt;=</span><span class="st"> </span><span class="kw">as.Date</span>(<span class="st">&quot;2020-12-01&quot;</span>) <span class="op">&amp;</span></span>
<span id="cb5-33"><a href="#cb5-33"></a><span class="st">           </span>Date_Time <span class="op">&lt;=</span><span class="st"> </span><span class="kw">as.Date</span>(<span class="st">&quot;2021-02-01&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb5-34"><a href="#cb5-34"></a><span class="st">  </span><span class="kw">arrange</span>(Date_Time) <span class="op">%&gt;%</span></span>
<span id="cb5-35"><a href="#cb5-35"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">time_lag =</span> <span class="kw">lag</span>(Date_Time, <span class="dt">default =</span> Date_Time[<span class="dv">1</span>]),</span>
<span id="cb5-36"><a href="#cb5-36"></a>         <span class="dt">diff_time =</span> <span class="kw">as.numeric</span>(<span class="kw">difftime</span>(Date_Time, time_lag, <span class="dt">units =</span> <span class="st">&quot;hours&quot;</span>))) <span class="op">%&gt;%</span></span>
<span id="cb5-37"><a href="#cb5-37"></a><span class="st">  </span><span class="kw">group_split</span>(<span class="kw">cumsum</span>(diff_time <span class="op">&gt;</span><span class="st"> </span><span class="dv">8</span>)) <span class="op">%&gt;%</span></span>
<span id="cb5-38"><a href="#cb5-38"></a><span class="st">  </span><span class="co">## remove events where max flow did not go over 10 cfs</span></span>
<span id="cb5-39"><a href="#cb5-39"></a><span class="st">  </span><span class="kw">keep</span>(<span class="op">~</span><span class="st"> </span><span class="kw">max</span>(<span class="kw">as.numeric</span>(.x<span class="op">$</span>Flow)) <span class="op">&gt;</span><span class="st"> </span><span class="dv">10</span>) <span class="op">%&gt;%</span></span>
<span id="cb5-40"><a href="#cb5-40"></a><span class="st">  </span><span class="kw">map</span>(<span class="op">~</span><span class="kw">select</span>(.x, Date_Time, Depth, Flow)) <span class="op">%&gt;%</span></span>
<span id="cb5-41"><a href="#cb5-41"></a><span class="st">  </span><span class="kw">map</span>(<span class="op">~</span><span class="kw">mutate</span>(.x,</span>
<span id="cb5-42"><a href="#cb5-42"></a>              <span class="dt">time_lag =</span> <span class="kw">lag</span>(Date_Time, <span class="dt">default =</span> Date_Time[<span class="dv">1</span>]),</span>
<span id="cb5-43"><a href="#cb5-43"></a>              <span class="dt">diff_time =</span> <span class="kw">as.numeric</span>(<span class="kw">difftime</span>(Date_Time, time_lag, <span class="dt">units =</span> <span class="st">&quot;hours&quot;</span>)),</span>
<span id="cb5-44"><a href="#cb5-44"></a>              <span class="dt">diff_depth =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">diff</span>(.x<span class="op">$</span>Depth)))) <span class="op">%&gt;%</span></span>
<span id="cb5-45"><a href="#cb5-45"></a><span class="st">  </span><span class="kw">imap</span>(<span class="op">~</span><span class="kw">mutate</span>(.x, <span class="dt">event =</span> <span class="kw">as.character</span>(.y))) <span class="op">%&gt;%</span></span>
<span id="cb5-46"><a href="#cb5-46"></a><span class="st">  </span><span class="kw">bind_rows</span>() <span class="op">%&gt;%</span></span>
<span id="cb5-47"><a href="#cb5-47"></a><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(diff_depth)) <span class="op">%&gt;%</span></span>
<span id="cb5-48"><a href="#cb5-48"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">J =</span> <span class="kw">as.numeric</span>(diff_depth)<span class="op">/</span><span class="kw">as.numeric</span>(diff_time)) -&gt;<span class="st"> </span>df_<span class="dv">16396</span>_<span class="dv">2021</span>_<span class="dv">02</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>SSE &lt;-<span class="st"> </span><span class="cf">function</span>(pars, data) {</span>
<span id="cb6-2"><a href="#cb6-2"></a>  Depth =<span class="st"> </span><span class="kw">as.numeric</span>(data<span class="op">$</span>Depth)</span>
<span id="cb6-3"><a href="#cb6-3"></a>  J =<span class="st"> </span>data<span class="op">$</span>J</span>
<span id="cb6-4"><a href="#cb6-4"></a>  K =<span class="st"> </span>pars[<span class="dv">1</span>]</span>
<span id="cb6-5"><a href="#cb6-5"></a>  a =<span class="st"> </span>pars[<span class="dv">2</span>]</span>
<span id="cb6-6"><a href="#cb6-6"></a>  n =<span class="st"> </span>pars[<span class="dv">3</span>]</span>
<span id="cb6-7"><a href="#cb6-7"></a>  x =<span class="st"> </span>pars[<span class="dv">4</span>]</span>
<span id="cb6-8"><a href="#cb6-8"></a></span>
<span id="cb6-9"><a href="#cb6-9"></a>  </span>
<span id="cb6-10"><a href="#cb6-10"></a>  preds &lt;-<span class="st"> </span>(K<span class="op">*</span><span class="kw">exponent</span>(<span class="dt">x =</span> Depth <span class="op">-</span><span class="st"> </span>a, <span class="dt">pow =</span> n)) <span class="op">*</span><span class="st"> </span><span class="kw">exponent</span>(<span class="dt">x =</span> (<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>x <span class="op">*</span><span class="st"> </span>J), <span class="dt">pow =</span> (<span class="dv">1</span><span class="op">/</span><span class="dv">2</span>))</span>
<span id="cb6-11"><a href="#cb6-11"></a>  <span class="co">#print(preds)</span></span>
<span id="cb6-12"><a href="#cb6-12"></a>  Q =<span class="st"> </span><span class="kw">as.numeric</span>(data<span class="op">$</span>Flow)</span>
<span id="cb6-13"><a href="#cb6-13"></a>  </span>
<span id="cb6-14"><a href="#cb6-14"></a>  <span class="co">## minimize the sum of square errors per the paper</span></span>
<span id="cb6-15"><a href="#cb6-15"></a>  sse &lt;-<span class="st"> </span><span class="kw">sum</span>((Q <span class="op">-</span><span class="st"> </span>preds)<span class="op">^</span><span class="dv">2</span>, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</span>
<span id="cb6-16"><a href="#cb6-16"></a>  <span class="co">#print(sse)</span></span>
<span id="cb6-17"><a href="#cb6-17"></a>  sse</span>
<span id="cb6-18"><a href="#cb6-18"></a>}</span>
<span id="cb6-19"><a href="#cb6-19"></a></span>
<span id="cb6-20"><a href="#cb6-20"></a>par &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">K =</span> <span class="dv">30</span>,</span>
<span id="cb6-21"><a href="#cb6-21"></a>         <span class="dt">a =</span> <span class="dv">1</span>,</span>
<span id="cb6-22"><a href="#cb6-22"></a>         <span class="dt">n =</span> <span class="dv">2</span>,</span>
<span id="cb6-23"><a href="#cb6-23"></a>         <span class="dt">x =</span> <span class="dv">1</span>)</span>
<span id="cb6-24"><a href="#cb6-24"></a></span>
<span id="cb6-25"><a href="#cb6-25"></a><span class="co">## limits to the parameter space</span></span>
<span id="cb6-26"><a href="#cb6-26"></a>lower &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="op">-</span><span class="dv">10</span>, <span class="fl">0.1</span>, <span class="dv">-10</span>, <span class="fl">0.0001</span>)</span>
<span id="cb6-27"><a href="#cb6-27"></a>upper &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">200</span>, <span class="dv">10</span>, <span class="dv">10</span>, <span class="dv">10</span>)</span>
<span id="cb6-28"><a href="#cb6-28"></a></span>
<span id="cb6-29"><a href="#cb6-29"></a>optim_par_<span class="dv">16396</span>_<span class="dv">2020</span>_<span class="dv">12</span> &lt;-<span class="st"> </span><span class="kw">optim</span>(<span class="dt">par =</span> par,</span>
<span id="cb6-30"><a href="#cb6-30"></a>                   <span class="dt">fn =</span> SSE,</span>
<span id="cb6-31"><a href="#cb6-31"></a>                   <span class="dt">data =</span> df_<span class="dv">16396</span>_<span class="dv">2020</span>_<span class="dv">12</span>,</span>
<span id="cb6-32"><a href="#cb6-32"></a>                   <span class="dt">lower =</span> lower,</span>
<span id="cb6-33"><a href="#cb6-33"></a>                   <span class="dt">upper =</span> upper,</span>
<span id="cb6-34"><a href="#cb6-34"></a>                   <span class="dt">method =</span> <span class="st">&quot;L-BFGS-B&quot;</span>)</span>
<span id="cb6-35"><a href="#cb6-35"></a></span>
<span id="cb6-36"><a href="#cb6-36"></a>optim_par_<span class="dv">16396</span>_<span class="dv">2021</span>_<span class="dv">02</span> &lt;-<span class="st"> </span><span class="kw">optim</span>(<span class="dt">par =</span> par,</span>
<span id="cb6-37"><a href="#cb6-37"></a>                   <span class="dt">fn =</span> SSE,</span>
<span id="cb6-38"><a href="#cb6-38"></a>                   <span class="dt">data =</span> df_<span class="dv">16396</span>_<span class="dv">2021</span>_<span class="dv">02</span>,</span>
<span id="cb6-39"><a href="#cb6-39"></a>                   <span class="dt">lower =</span> lower,</span>
<span id="cb6-40"><a href="#cb6-40"></a>                   <span class="dt">upper =</span> upper,</span>
<span id="cb6-41"><a href="#cb6-41"></a>                   <span class="dt">method =</span> <span class="st">&quot;L-BFGS-B&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="co">## setup dataframe with parameter results. Will use this later to report parameters and GOF metrics</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>df_results_<span class="dv">16369</span> &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">Site =</span> <span class="kw">c</span>(<span class="st">&quot;16396&quot;</span>,<span class="st">&quot;16396&quot;</span>),</span>
<span id="cb7-3"><a href="#cb7-3"></a>                           <span class="dt">Period =</span> <span class="kw">c</span>(<span class="st">&quot;2020-03-01 : 2020-11-30&quot;</span>,</span>
<span id="cb7-4"><a href="#cb7-4"></a>                                      <span class="st">&quot;2020-12-01 : 2021-01-31&quot;</span>),</span>
<span id="cb7-5"><a href="#cb7-5"></a>                           <span class="dt">K =</span> <span class="kw">c</span>(optim_par_<span class="dv">16396</span>_<span class="dv">2020</span>_<span class="dv">12</span><span class="op">$</span>par[[<span class="dv">1</span>]],</span>
<span id="cb7-6"><a href="#cb7-6"></a>                                 optim_par_<span class="dv">16396</span>_<span class="dv">2021</span>_<span class="dv">02</span><span class="op">$</span>par[[<span class="dv">1</span>]]),</span>
<span id="cb7-7"><a href="#cb7-7"></a>                           <span class="dt">a =</span> <span class="kw">c</span>(optim_par_<span class="dv">16396</span>_<span class="dv">2020</span>_<span class="dv">12</span><span class="op">$</span>par[[<span class="dv">2</span>]],</span>
<span id="cb7-8"><a href="#cb7-8"></a>                                 optim_par_<span class="dv">16396</span>_<span class="dv">2021</span>_<span class="dv">02</span><span class="op">$</span>par[[<span class="dv">2</span>]]),</span>
<span id="cb7-9"><a href="#cb7-9"></a>                           <span class="dt">n =</span> <span class="kw">c</span>(optim_par_<span class="dv">16396</span>_<span class="dv">2020</span>_<span class="dv">12</span><span class="op">$</span>par[[<span class="dv">3</span>]],</span>
<span id="cb7-10"><a href="#cb7-10"></a>                                 optim_par_<span class="dv">16396</span>_<span class="dv">2021</span>_<span class="dv">02</span><span class="op">$</span>par[[<span class="dv">3</span>]]),</span>
<span id="cb7-11"><a href="#cb7-11"></a>                           <span class="dt">x =</span> <span class="kw">c</span>(optim_par_<span class="dv">16396</span>_<span class="dv">2020</span>_<span class="dv">12</span><span class="op">$</span>par[[<span class="dv">4</span>]],</span>
<span id="cb7-12"><a href="#cb7-12"></a>                                 optim_par_<span class="dv">16396</span>_<span class="dv">2021</span>_<span class="dv">02</span><span class="op">$</span>par[[<span class="dv">4</span>]]))</span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="co">## Develop rating curve predictions and</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="co">## create table with GOF metrics</span></span>
<span id="cb8-3"><a href="#cb8-3"></a>df_<span class="dv">16396</span>_<span class="dv">2020</span>_<span class="dv">12</span> <span class="op">%&gt;%</span></span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">predicted =</span> (df_results_<span class="dv">16369</span><span class="op">$</span>K[<span class="dv">1</span>]<span class="op">*</span><span class="kw">exponent</span>(<span class="dt">x =</span> <span class="kw">as.numeric</span>(Depth) <span class="op">-</span><span class="st"> </span>df_results_<span class="dv">16369</span><span class="op">$</span>a[<span class="dv">1</span>], <span class="dt">pow =</span> df_results_<span class="dv">16369</span><span class="op">$</span>n[<span class="dv">1</span>])) <span class="op">*</span><span class="st"> </span><span class="kw">exponent</span>(<span class="dt">x =</span> (<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>df_results_<span class="dv">16369</span><span class="op">$</span>x[<span class="dv">1</span>] <span class="op">*</span><span class="st"> </span>J), <span class="dt">pow =</span> (<span class="dv">1</span><span class="op">/</span><span class="dv">2</span>))) -&gt;<span class="st"> </span>df_<span class="dv">16396</span>_<span class="dv">2020</span>_<span class="dv">12</span></span>
<span id="cb8-5"><a href="#cb8-5"></a></span>
<span id="cb8-6"><a href="#cb8-6"></a>df_<span class="dv">16396</span>_<span class="dv">2021</span>_<span class="dv">02</span> <span class="op">%&gt;%</span></span>
<span id="cb8-7"><a href="#cb8-7"></a><span class="st">      </span><span class="kw">mutate</span>(<span class="dt">predicted =</span> (df_results_<span class="dv">16369</span><span class="op">$</span>K[<span class="dv">2</span>]<span class="op">*</span><span class="kw">exponent</span>(<span class="dt">x =</span> <span class="kw">as.numeric</span>(Depth) <span class="op">-</span><span class="st"> </span>df_results_<span class="dv">16369</span><span class="op">$</span>a[<span class="dv">2</span>], <span class="dt">pow =</span> df_results_<span class="dv">16369</span><span class="op">$</span>n[<span class="dv">2</span>])) <span class="op">*</span><span class="st"> </span><span class="kw">exponent</span>(<span class="dt">x =</span> (<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>df_results_<span class="dv">16369</span><span class="op">$</span>x[<span class="dv">2</span>] <span class="op">*</span><span class="st"> </span>J), <span class="dt">pow =</span> (<span class="dv">1</span><span class="op">/</span><span class="dv">2</span>))) -&gt;<span class="st"> </span>df_<span class="dv">16396</span>_<span class="dv">2021</span>_<span class="dv">02</span></span>
<span id="cb8-8"><a href="#cb8-8"></a></span>
<span id="cb8-9"><a href="#cb8-9"></a></span>
<span id="cb8-10"><a href="#cb8-10"></a>df_results_<span class="dv">16369</span> <span class="op">%&gt;%</span></span>
<span id="cb8-11"><a href="#cb8-11"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">NSE =</span> <span class="kw">c</span>(</span>
<span id="cb8-12"><a href="#cb8-12"></a>    hydroGOF<span class="op">::</span><span class="kw">NSE</span>(df_<span class="dv">16396</span>_<span class="dv">2020</span>_<span class="dv">12</span><span class="op">$</span>predicted, <span class="kw">as.numeric</span>(df_<span class="dv">16396</span>_<span class="dv">2020</span>_<span class="dv">12</span><span class="op">$</span>Flow)),</span>
<span id="cb8-13"><a href="#cb8-13"></a>    hydroGOF<span class="op">::</span><span class="kw">NSE</span>(df_<span class="dv">16396</span>_<span class="dv">2021</span>_<span class="dv">02</span><span class="op">$</span>predicted, <span class="kw">as.numeric</span>(df_<span class="dv">16396</span>_<span class="dv">2021</span>_<span class="dv">02</span><span class="op">$</span>Flow))),</span>
<span id="cb8-14"><a href="#cb8-14"></a>    <span class="dt">nRMSE =</span> <span class="kw">c</span>(hydroGOF<span class="op">::</span><span class="kw">nrmse</span>(df_<span class="dv">16396</span>_<span class="dv">2020</span>_<span class="dv">12</span><span class="op">$</span>predicted, <span class="kw">as.numeric</span>(df_<span class="dv">16396</span>_<span class="dv">2020</span>_<span class="dv">12</span><span class="op">$</span>Flow), <span class="dt">norm =</span> <span class="st">&quot;maxmin&quot;</span>),</span>
<span id="cb8-15"><a href="#cb8-15"></a>              hydroGOF<span class="op">::</span><span class="kw">nrmse</span>(df_<span class="dv">16396</span>_<span class="dv">2021</span>_<span class="dv">02</span><span class="op">$</span>predicted, <span class="kw">as.numeric</span>(df_<span class="dv">16396</span>_<span class="dv">2021</span>_<span class="dv">02</span><span class="op">$</span>Flow), <span class="dt">norm =</span> <span class="st">&quot;maxmin&quot;</span>))</span>
<span id="cb8-16"><a href="#cb8-16"></a>    ) -&gt;<span class="st"> </span>df_results_<span class="dv">16369</span></span>
<span id="cb8-17"><a href="#cb8-17"></a></span>
<span id="cb8-18"><a href="#cb8-18"></a><span class="co">##display table</span></span>
<span id="cb8-19"><a href="#cb8-19"></a><span class="kw">kable</span>(df_results_<span class="dv">16369</span>, </span>
<span id="cb8-20"><a href="#cb8-20"></a>      <span class="dt">caption =</span> <span class="st">&quot;Rating curve parameter estimates and goodness-of-fit metrics for station 16369.&quot;</span>) </span></code></pre></div>
<table>
<caption><span id="tab:results16369">Table 1: </span>Rating curve parameter estimates and goodness-of-fit metrics for station 16369.</caption>
<thead>
<tr class="header">
<th align="left">Site</th>
<th align="left">Period</th>
<th align="right">K</th>
<th align="right">a</th>
<th align="right">n</th>
<th align="right">x</th>
<th align="right">NSE</th>
<th align="right">nRMSE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">16396</td>
<td align="left">2020-03-01 : 2020-11-30</td>
<td align="right">24.15103</td>
<td align="right">1.275218</td>
<td align="right">1.639702</td>
<td align="right">0.0001000</td>
<td align="right">0.9802261</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">16396</td>
<td align="left">2020-12-01 : 2021-01-31</td>
<td align="right">26.47283</td>
<td align="right">1.226563</td>
<td align="right">1.722387</td>
<td align="right">0.5904576</td>
<td align="right">0.9778216</td>
<td align="right">2</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="co">## plot rating curve results</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>df_<span class="dv">16396</span>_<span class="dv">2020</span>_<span class="dv">12</span> <span class="op">%&gt;%</span></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="st">  </span><span class="kw">bind_rows</span>(df_<span class="dv">16396</span>_<span class="dv">2021</span>_<span class="dv">02</span>) <span class="op">%&gt;%</span></span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">predicted =</span> <span class="kw">set_units</span>(predicted, <span class="st">&quot;ft^3/s&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="st">  </span><span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb9-6"><a href="#cb9-6"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="kw">as.numeric</span>(predicted), <span class="kw">as.numeric</span>(Flow), <span class="dt">color =</span> <span class="st">&quot;Rating curve prediction against measured flow&quot;</span>), <span class="dt">alpha =</span> <span class="fl">0.25</span>) <span class="op">+</span></span>
<span id="cb9-7"><a href="#cb9-7"></a><span class="st">  </span><span class="kw">geom_abline</span>(<span class="kw">aes</span>(<span class="dt">slope =</span> <span class="dv">1</span>, <span class="dt">intercept =</span> <span class="dv">0</span>, <span class="dt">linetype =</span> <span class="st">&quot;1:1 line&quot;</span>)) <span class="op">+</span></span>
<span id="cb9-8"><a href="#cb9-8"></a><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">name =</span> <span class="st">&quot;Rating curve flow estimate [cfs]&quot;</span>, <span class="dt">trans =</span> <span class="st">&quot;log10&quot;</span>) <span class="op">+</span></span>
<span id="cb9-9"><a href="#cb9-9"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">name =</span> <span class="st">&quot;Measured flow [cfs]&quot;</span>, <span class="dt">trans =</span> <span class="st">&quot;log10&quot;</span>) <span class="op">+</span></span>
<span id="cb9-10"><a href="#cb9-10"></a><span class="st">  </span><span class="kw">theme_ms</span>() <span class="op">+</span></span>
<span id="cb9-11"><a href="#cb9-11"></a><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.title =</span> <span class="kw">element_blank</span>())</span></code></pre></div>
<pre><code>## Warning: Removed 8 rows containing missing values (geom_point).</code></pre>
<div class="figure"><span id="fig:metricplot16396"></span>
<img src="document_files/figure-html/metricplot16396-1.png" alt="Scatter plot of rating curve estimated flows against measured flows at station 16396" width="672" />
<p class="caption">
Figure 1: Scatter plot of rating curve estimated flows against measured flows at station 16396
</p>
</div>
<p>*** add plot of full predicted flows over time using hobo data ***</p>
</div>
<div id="site-16397" class="section level3">
<h3>Site 16397</h3>
<p>Exploratory analysis indicated pooled conditions when during doppler flow meter deployment from August 2020 through November 2020. A single rating curve was developed at this site using the power function (Formula <a href="#eq:powerfunction">(1)</a>) since unsteady flow conditions were not observed in the hydrographs. Rating curve predictions resulted in NSE greater than 0.95 indicating excellent fit (Table <a href="#tab:results16369">1</a>). The nRMSE was less than 6%, which is likely a good result for the smaller sample sized obtained at this station and probably influenced by the observed low flow variance (Table <a href="#tab:results16369">1</a>; Figure <a href="#fig:metricplot16396">1</a>).</p>
<p>*** add plot of full predicted flows over time using hobo data ***</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="co">## setup dataframe to fit rating curve to 16397</span></span>
<span id="cb11-2"><a href="#cb11-2"></a></span>
<span id="cb11-3"><a href="#cb11-3"></a>iqplus_df <span class="op">%&gt;%</span></span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="st">  </span><span class="kw">filter</span>(Site <span class="op">==</span><span class="st"> &quot;16397&quot;</span>,</span>
<span id="cb11-5"><a href="#cb11-5"></a>         System_Status <span class="op">==</span><span class="st"> </span><span class="dv">0</span>,</span>
<span id="cb11-6"><a href="#cb11-6"></a>         System_In_Water <span class="op">==</span><span class="st"> </span><span class="dv">100</span>,</span>
<span id="cb11-7"><a href="#cb11-7"></a>         <span class="kw">as.numeric</span>(Depth) <span class="op">&gt;=</span><span class="st"> </span><span class="fl">0.26</span>, <span class="co">## minimum operating depth</span></span>
<span id="cb11-8"><a href="#cb11-8"></a>         <span class="kw">as.numeric</span>(Flow) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span></span>
<span id="cb11-9"><a href="#cb11-9"></a><span class="st">  </span><span class="kw">filter</span>(Date_Time <span class="op">&gt;=</span><span class="st"> </span><span class="kw">as.POSIXct</span>(<span class="st">&quot;2020-12-15&quot;</span>) <span class="op">&amp;</span><span class="st"> </span></span>
<span id="cb11-10"><a href="#cb11-10"></a><span class="st">           </span>Date_Time <span class="op">&gt;=</span><span class="st"> </span><span class="kw">as.POSIXct</span>(<span class="st">&quot;2020-12-31&quot;</span>) <span class="op">&amp;</span></span>
<span id="cb11-11"><a href="#cb11-11"></a><span class="st">           </span><span class="kw">as.numeric</span>(Depth) <span class="op">&gt;</span><span class="st"> </span><span class="fl">1.5</span> <span class="op">|</span></span>
<span id="cb11-12"><a href="#cb11-12"></a><span class="st">           </span>Date_Time <span class="op">&gt;=</span><span class="st"> </span><span class="kw">as.POSIXct</span>(<span class="st">&quot;2020-01-05&quot;</span>) <span class="op">&amp;</span></span>
<span id="cb11-13"><a href="#cb11-13"></a><span class="st">           </span><span class="kw">as.numeric</span>(Depth) <span class="op">&gt;</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span></span>
<span id="cb11-14"><a href="#cb11-14"></a><span class="st">  </span><span class="co"># filter(as.numeric(Depth) &lt; 2 &amp; as.numeric(Flow) &lt; 4.3 | # low flow outliers filtered based on boxplots</span></span>
<span id="cb11-15"><a href="#cb11-15"></a><span class="st">  </span><span class="co">#          as.numeric(Depth) &gt;= 2) %&gt;%</span></span>
<span id="cb11-16"><a href="#cb11-16"></a><span class="st">  </span><span class="kw">arrange</span>(Date_Time) <span class="op">%&gt;%</span></span>
<span id="cb11-17"><a href="#cb11-17"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">time_lag =</span> <span class="kw">lag</span>(Date_Time, <span class="dt">default =</span> Date_Time[<span class="dv">1</span>]),</span>
<span id="cb11-18"><a href="#cb11-18"></a>         <span class="dt">diff_time =</span> <span class="kw">as.numeric</span>(<span class="kw">difftime</span>(Date_Time, time_lag, <span class="dt">units =</span> <span class="st">&quot;hours&quot;</span>))) <span class="op">%&gt;%</span></span>
<span id="cb11-19"><a href="#cb11-19"></a><span class="st">  </span><span class="kw">group_split</span>(<span class="kw">cumsum</span>(diff_time <span class="op">&gt;</span><span class="st"> </span><span class="dv">8</span>)) <span class="op">%&gt;%</span></span>
<span id="cb11-20"><a href="#cb11-20"></a><span class="st">  </span><span class="co">## remove events where max flow did not go over 10 cfs</span></span>
<span id="cb11-21"><a href="#cb11-21"></a><span class="st">  </span><span class="co">## keep(~ max(as.numeric(.x$Flow)) &gt; 10) %&gt;%</span></span>
<span id="cb11-22"><a href="#cb11-22"></a><span class="st">  </span><span class="kw">map</span>(<span class="op">~</span><span class="kw">select</span>(.x, Date_Time, Depth, Flow)) <span class="op">%&gt;%</span></span>
<span id="cb11-23"><a href="#cb11-23"></a><span class="st">  </span><span class="kw">map</span>(<span class="op">~</span><span class="kw">mutate</span>(.x,</span>
<span id="cb11-24"><a href="#cb11-24"></a>              <span class="dt">time_lag =</span> <span class="kw">lag</span>(Date_Time, <span class="dt">default =</span> Date_Time[<span class="dv">1</span>]),</span>
<span id="cb11-25"><a href="#cb11-25"></a>              <span class="dt">diff_time =</span> <span class="kw">as.numeric</span>(<span class="kw">difftime</span>(Date_Time, time_lag, <span class="dt">units =</span> <span class="st">&quot;hours&quot;</span>)),</span>
<span id="cb11-26"><a href="#cb11-26"></a>              <span class="dt">diff_depth =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">diff</span>(.x<span class="op">$</span>Depth)))) <span class="op">%&gt;%</span></span>
<span id="cb11-27"><a href="#cb11-27"></a><span class="st">  </span><span class="kw">imap</span>(<span class="op">~</span><span class="kw">mutate</span>(.x, <span class="dt">event =</span> <span class="kw">as.character</span>(.y))) <span class="op">%&gt;%</span></span>
<span id="cb11-28"><a href="#cb11-28"></a><span class="st">  </span><span class="kw">bind_rows</span>() <span class="op">%&gt;%</span></span>
<span id="cb11-29"><a href="#cb11-29"></a><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(diff_depth)) <span class="op">%&gt;%</span></span>
<span id="cb11-30"><a href="#cb11-30"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">J =</span> <span class="kw">as.numeric</span>(diff_depth)<span class="op">/</span><span class="kw">as.numeric</span>(diff_time)) -&gt;<span class="st"> </span>df_<span class="dv">16397</span></span>
<span id="cb11-31"><a href="#cb11-31"></a></span>
<span id="cb11-32"><a href="#cb11-32"></a></span>
<span id="cb11-33"><a href="#cb11-33"></a>SSE &lt;-<span class="st"> </span><span class="cf">function</span>(pars, data) {</span>
<span id="cb11-34"><a href="#cb11-34"></a>  Depth =<span class="st"> </span><span class="kw">as.numeric</span>(data<span class="op">$</span>Depth)</span>
<span id="cb11-35"><a href="#cb11-35"></a>  K =<span class="st"> </span>pars[<span class="dv">1</span>]</span>
<span id="cb11-36"><a href="#cb11-36"></a>  H_<span class="dv">0</span> =<span class="st"> </span>pars[<span class="dv">2</span>]</span>
<span id="cb11-37"><a href="#cb11-37"></a>  Z =<span class="st"> </span>pars[<span class="dv">3</span>]</span>
<span id="cb11-38"><a href="#cb11-38"></a></span>
<span id="cb11-39"><a href="#cb11-39"></a></span>
<span id="cb11-40"><a href="#cb11-40"></a>  preds &lt;-<span class="st"> </span>K<span class="op">*</span>(<span class="kw">as.numeric</span>(Depth) <span class="op">-</span><span class="st"> </span>H_<span class="dv">0</span>)<span class="op">^</span>Z</span>
<span id="cb11-41"><a href="#cb11-41"></a>  <span class="co">#print(preds)</span></span>
<span id="cb11-42"><a href="#cb11-42"></a>  Q =<span class="st"> </span><span class="kw">as.numeric</span>(data<span class="op">$</span>Flow)</span>
<span id="cb11-43"><a href="#cb11-43"></a></span>
<span id="cb11-44"><a href="#cb11-44"></a>  <span class="co">## minimize the sum of square errors per the paper</span></span>
<span id="cb11-45"><a href="#cb11-45"></a>  sse &lt;-<span class="st"> </span><span class="kw">sum</span>((Q <span class="op">-</span><span class="st"> </span>preds)<span class="op">^</span><span class="dv">2</span>, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</span>
<span id="cb11-46"><a href="#cb11-46"></a>  <span class="co">#print(sse)</span></span>
<span id="cb11-47"><a href="#cb11-47"></a>  sse</span>
<span id="cb11-48"><a href="#cb11-48"></a>}</span>
<span id="cb11-49"><a href="#cb11-49"></a></span>
<span id="cb11-50"><a href="#cb11-50"></a>par &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">K =</span> <span class="dv">1</span>,</span>
<span id="cb11-51"><a href="#cb11-51"></a>         <span class="dt">H_0 =</span> <span class="fl">.001</span>,</span>
<span id="cb11-52"><a href="#cb11-52"></a>         <span class="dt">Z =</span> <span class="dv">2</span>)</span>
<span id="cb11-53"><a href="#cb11-53"></a></span>
<span id="cb11-54"><a href="#cb11-54"></a><span class="co">## limits to the parameter space</span></span>
<span id="cb11-55"><a href="#cb11-55"></a>lower &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="op">-</span><span class="ot">Inf</span>, <span class="dv">-5</span>, <span class="fl">0.001</span>)</span>
<span id="cb11-56"><a href="#cb11-56"></a>upper &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="ot">Inf</span>, <span class="dv">5</span>, <span class="ot">Inf</span>)</span>
<span id="cb11-57"><a href="#cb11-57"></a></span>
<span id="cb11-58"><a href="#cb11-58"></a>optim_par_<span class="dv">16397</span> &lt;-<span class="st"> </span><span class="kw">optim</span>(<span class="dt">par =</span> par,</span>
<span id="cb11-59"><a href="#cb11-59"></a>                   <span class="dt">fn =</span> SSE,</span>
<span id="cb11-60"><a href="#cb11-60"></a>                   <span class="dt">data =</span> df_<span class="dv">16397</span>,</span>
<span id="cb11-61"><a href="#cb11-61"></a>                   <span class="dt">lower =</span> lower,</span>
<span id="cb11-62"><a href="#cb11-62"></a>                   <span class="dt">upper =</span> upper,</span>
<span id="cb11-63"><a href="#cb11-63"></a>                   <span class="dt">method =</span> <span class="st">&quot;L-BFGS-B&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a><span class="co">## setup dataframe with parameter results. Will use this later to report parameters and GOF metrics</span></span>
<span id="cb12-2"><a href="#cb12-2"></a>df_results_<span class="dv">16397</span> &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">Site =</span> <span class="kw">c</span>(<span class="st">&quot;16397&quot;</span>),</span>
<span id="cb12-3"><a href="#cb12-3"></a>                           <span class="dt">Period =</span> <span class="kw">c</span>(<span class="st">&quot;2020-03-01 : 2020-01-30&quot;</span>),</span>
<span id="cb12-4"><a href="#cb12-4"></a>                           <span class="dt">K =</span> <span class="kw">c</span>(optim_par_<span class="dv">16397</span><span class="op">$</span>par[[<span class="dv">1</span>]]),</span>
<span id="cb12-5"><a href="#cb12-5"></a>                           <span class="dt">H_0 =</span> <span class="kw">c</span>(optim_par_<span class="dv">16397</span><span class="op">$</span>par[[<span class="dv">2</span>]]),</span>
<span id="cb12-6"><a href="#cb12-6"></a>                           <span class="dt">Z =</span> <span class="kw">c</span>(optim_par_<span class="dv">16397</span><span class="op">$</span>par[[<span class="dv">3</span>]]))</span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>df_<span class="dv">16397</span> <span class="op">%&gt;%</span></span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">predicted =</span> df_results_<span class="dv">16397</span><span class="op">$</span>K[<span class="dv">1</span>]<span class="op">*</span>(<span class="kw">as.numeric</span>(Depth) <span class="op">-</span><span class="st"> </span>df_results_<span class="dv">16397</span><span class="op">$</span>H_<span class="dv">0</span>[<span class="dv">1</span>])<span class="op">^</span>df_results_<span class="dv">16397</span><span class="op">$</span>Z[<span class="dv">1</span>]) -&gt;<span class="st"> </span>df_<span class="dv">16397</span></span>
<span id="cb13-3"><a href="#cb13-3"></a></span>
<span id="cb13-4"><a href="#cb13-4"></a></span>
<span id="cb13-5"><a href="#cb13-5"></a>df_results_<span class="dv">16397</span> <span class="op">%&gt;%</span></span>
<span id="cb13-6"><a href="#cb13-6"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">NSE =</span> hydroGOF<span class="op">::</span><span class="kw">NSE</span>(df_<span class="dv">16397</span><span class="op">$</span>predicted, <span class="kw">as.numeric</span>(df_<span class="dv">16397</span><span class="op">$</span>Flow)),</span>
<span id="cb13-7"><a href="#cb13-7"></a>         <span class="dt">nRMSE =</span> hydroGOF<span class="op">::</span><span class="kw">nrmse</span>(df_<span class="dv">16397</span><span class="op">$</span>predicted, <span class="kw">as.numeric</span>(df_<span class="dv">16397</span><span class="op">$</span>Flow),</span>
<span id="cb13-8"><a href="#cb13-8"></a>                              <span class="dt">norm=</span><span class="st">&quot;maxmin&quot;</span>)) -&gt;<span class="st"> </span>df_results_<span class="dv">16397</span></span>
<span id="cb13-9"><a href="#cb13-9"></a></span>
<span id="cb13-10"><a href="#cb13-10"></a><span class="kw">kable</span>(df_results_<span class="dv">16397</span>,</span>
<span id="cb13-11"><a href="#cb13-11"></a>      <span class="dt">caption =</span> <span class="st">&quot;Rating curve parameter estimates and goodness-of-fit metrics for station 16397.&quot;</span>)</span></code></pre></div>
<table>
<caption><span id="tab:results16397">Table 2: </span>Rating curve parameter estimates and goodness-of-fit metrics for station 16397.</caption>
<thead>
<tr class="header">
<th align="left">Site</th>
<th align="left">Period</th>
<th align="right">K</th>
<th align="right">H_0</th>
<th align="right">Z</th>
<th align="right">NSE</th>
<th align="right">nRMSE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">16397</td>
<td align="left">2020-03-01 : 2020-01-30</td>
<td align="right">0.0007257</td>
<td align="right">-3.756137</td>
<td align="right">4.47589</td>
<td align="right">0.8471358</td>
<td align="right">4.7</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="co">## plot rating curve results</span></span>
<span id="cb14-2"><a href="#cb14-2"></a>df_<span class="dv">16397</span> <span class="op">%&gt;%</span></span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">predicted =</span> <span class="kw">set_units</span>(predicted, <span class="st">&quot;ft^3/s&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb14-4"><a href="#cb14-4"></a><span class="st">  </span><span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb14-5"><a href="#cb14-5"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="kw">as.numeric</span>(predicted), <span class="kw">as.numeric</span>(Flow), <span class="dt">color =</span> <span class="st">&quot;Rating curve prediction against measured flow&quot;</span>), <span class="dt">alpha =</span> <span class="fl">0.9</span>) <span class="op">+</span></span>
<span id="cb14-6"><a href="#cb14-6"></a><span class="st">  </span><span class="kw">geom_abline</span>(<span class="kw">aes</span>(<span class="dt">slope =</span> <span class="dv">1</span>, <span class="dt">intercept =</span> <span class="dv">0</span>, <span class="dt">linetype =</span> <span class="st">&quot;1:1 line&quot;</span>)) <span class="op">+</span></span>
<span id="cb14-7"><a href="#cb14-7"></a><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">name =</span> <span class="st">&quot;Rating curve flow estimate [cfs]&quot;</span>, <span class="dt">trans =</span> <span class="st">&quot;log10&quot;</span>) <span class="op">+</span></span>
<span id="cb14-8"><a href="#cb14-8"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">name =</span> <span class="st">&quot;Measured flow [cfs]&quot;</span>, <span class="dt">trans =</span> <span class="st">&quot;log10&quot;</span>) <span class="op">+</span></span>
<span id="cb14-9"><a href="#cb14-9"></a><span class="st">  </span><span class="kw">theme_ms</span>() <span class="op">+</span></span>
<span id="cb14-10"><a href="#cb14-10"></a><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.title =</span> <span class="kw">element_blank</span>())</span></code></pre></div>
<div class="figure"><span id="fig:metricplot16397"></span>
<img src="document_files/figure-html/metricplot16397-1.png" alt="Scatter plot of rating curve estimated flows against measured flows at station 16397" width="672" />
<p class="caption">
Figure 2: Scatter plot of rating curve estimated flows against measured flows at station 16397
</p>
</div>
</div>
<div id="site-16882" class="section level3">
<h3>Site 16882</h3>
<p>Based on exploratory analysis, three rating curves were developed for site 16396. The rating curve periods were 2020-03-03 through 2020-05-30; 2020-06-01 through 2020-10-31; and 2020-11-01 through 2021-01-31. Due to apparent unsteady flow in the observed hydrogaphs, we applied the Jones formula (Formula<a href="#eq:Jonesformula">(2)</a>).</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="co">## make 3 different dataframes to fit jones formula to.</span></span>
<span id="cb15-2"><a href="#cb15-2"></a></span>
<span id="cb15-3"><a href="#cb15-3"></a>iqplus_df <span class="op">%&gt;%</span></span>
<span id="cb15-4"><a href="#cb15-4"></a><span class="st">  </span><span class="kw">filter</span>(Site <span class="op">==</span><span class="st"> &quot;16882&quot;</span>,</span>
<span id="cb15-5"><a href="#cb15-5"></a>         System_Status <span class="op">==</span><span class="st"> </span><span class="dv">0</span>,</span>
<span id="cb15-6"><a href="#cb15-6"></a>         System_In_Water <span class="op">==</span><span class="st"> </span><span class="dv">100</span>,</span>
<span id="cb15-7"><a href="#cb15-7"></a>         <span class="kw">as.numeric</span>(Depth) <span class="op">&gt;=</span><span class="st"> </span><span class="fl">0.26</span>, <span class="co">## minimum operating depth</span></span>
<span id="cb15-8"><a href="#cb15-8"></a>         <span class="kw">as.numeric</span>(Flow) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span></span>
<span id="cb15-9"><a href="#cb15-9"></a><span class="st">    </span><span class="kw">filter</span>(Date_Time <span class="op">&gt;</span><span class="st"> </span><span class="kw">as.POSIXct</span>(<span class="st">&quot;2020-05-01&quot;</span>) <span class="op">&amp;</span></span>
<span id="cb15-10"><a href="#cb15-10"></a><span class="st">           </span>Date_Time <span class="op">&lt;</span><span class="st"> </span><span class="kw">as.POSIXct</span>(<span class="st">&quot;2020-06-01&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb15-11"><a href="#cb15-11"></a><span class="st">  </span><span class="co">## remove outliers identified in box plots under 1 foot depth</span></span>
<span id="cb15-12"><a href="#cb15-12"></a><span class="st">  </span><span class="kw">filter</span>(<span class="kw">as.numeric</span>(Depth) <span class="op">&lt;</span><span class="st"> </span><span class="dv">1</span> <span class="op">&amp;</span><span class="st"> </span><span class="kw">as.numeric</span>(Flow) <span class="op">&lt;</span><span class="st"> </span><span class="fl">4.3</span> <span class="op">|</span></span>
<span id="cb15-13"><a href="#cb15-13"></a><span class="st">           </span><span class="kw">as.numeric</span>(Depth) <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span></span>
<span id="cb15-14"><a href="#cb15-14"></a><span class="st">  </span><span class="kw">arrange</span>(Date_Time) <span class="op">%&gt;%</span></span>
<span id="cb15-15"><a href="#cb15-15"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">time_lag =</span> <span class="kw">lag</span>(Date_Time, <span class="dt">default =</span> Date_Time[<span class="dv">1</span>]),</span>
<span id="cb15-16"><a href="#cb15-16"></a>         <span class="dt">diff_time =</span> <span class="kw">as.numeric</span>(<span class="kw">difftime</span>(Date_Time, time_lag, <span class="dt">units =</span> <span class="st">&quot;hours&quot;</span>))) <span class="op">%&gt;%</span></span>
<span id="cb15-17"><a href="#cb15-17"></a><span class="st">  </span><span class="kw">group_split</span>(<span class="kw">cumsum</span>(diff_time <span class="op">&gt;</span><span class="st"> </span><span class="dv">8</span>)) <span class="op">%&gt;%</span></span>
<span id="cb15-18"><a href="#cb15-18"></a><span class="st">  </span><span class="co">## remove events where max flow did not go over 10 cfs</span></span>
<span id="cb15-19"><a href="#cb15-19"></a><span class="st">  </span><span class="kw">keep</span>(<span class="op">~</span><span class="st"> </span><span class="kw">max</span>(<span class="kw">as.numeric</span>(.x<span class="op">$</span>Flow)) <span class="op">&gt;</span><span class="st"> </span><span class="dv">10</span>) <span class="op">%&gt;%</span></span>
<span id="cb15-20"><a href="#cb15-20"></a><span class="st">  </span><span class="kw">map</span>(<span class="op">~</span><span class="kw">select</span>(.x, Date_Time, Depth, Flow)) <span class="op">%&gt;%</span></span>
<span id="cb15-21"><a href="#cb15-21"></a><span class="st">  </span><span class="kw">map</span>(<span class="op">~</span><span class="kw">mutate</span>(.x,</span>
<span id="cb15-22"><a href="#cb15-22"></a>              <span class="dt">time_lag =</span> <span class="kw">lag</span>(Date_Time, <span class="dt">default =</span> Date_Time[<span class="dv">1</span>]),</span>
<span id="cb15-23"><a href="#cb15-23"></a>              <span class="dt">diff_time =</span> <span class="kw">as.numeric</span>(<span class="kw">difftime</span>(Date_Time, time_lag, <span class="dt">units =</span> <span class="st">&quot;hours&quot;</span>)),</span>
<span id="cb15-24"><a href="#cb15-24"></a>              <span class="dt">diff_depth =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">diff</span>(.x<span class="op">$</span>Depth)))) <span class="op">%&gt;%</span></span>
<span id="cb15-25"><a href="#cb15-25"></a><span class="st">  </span><span class="kw">imap</span>(<span class="op">~</span><span class="kw">mutate</span>(.x, <span class="dt">event =</span> <span class="kw">as.character</span>(.y))) <span class="op">%&gt;%</span></span>
<span id="cb15-26"><a href="#cb15-26"></a><span class="st">  </span><span class="kw">bind_rows</span>() <span class="op">%&gt;%</span></span>
<span id="cb15-27"><a href="#cb15-27"></a><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(diff_depth)) <span class="op">%&gt;%</span></span>
<span id="cb15-28"><a href="#cb15-28"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">J =</span> <span class="kw">as.numeric</span>(diff_depth)<span class="op">/</span><span class="kw">as.numeric</span>(diff_time)) -&gt;<span class="st"> </span>df_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">03</span></span>
<span id="cb15-29"><a href="#cb15-29"></a></span>
<span id="cb15-30"><a href="#cb15-30"></a>iqplus_df <span class="op">%&gt;%</span></span>
<span id="cb15-31"><a href="#cb15-31"></a><span class="st">  </span><span class="kw">filter</span>(Site <span class="op">==</span><span class="st"> &quot;16882&quot;</span>,</span>
<span id="cb15-32"><a href="#cb15-32"></a>         System_Status <span class="op">==</span><span class="st"> </span><span class="dv">0</span>,</span>
<span id="cb15-33"><a href="#cb15-33"></a>         System_In_Water <span class="op">==</span><span class="st"> </span><span class="dv">100</span>,</span>
<span id="cb15-34"><a href="#cb15-34"></a>         <span class="kw">as.numeric</span>(Depth) <span class="op">&gt;=</span><span class="st"> </span><span class="fl">0.26</span>, <span class="co">## minimum operating depth</span></span>
<span id="cb15-35"><a href="#cb15-35"></a>         <span class="kw">as.numeric</span>(Flow) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span></span>
<span id="cb15-36"><a href="#cb15-36"></a><span class="st">    </span><span class="kw">filter</span>(Date_Time <span class="op">&gt;=</span><span class="st"> </span><span class="kw">as.POSIXct</span>(<span class="st">&quot;2020-06-01&quot;</span>) <span class="op">&amp;</span></span>
<span id="cb15-37"><a href="#cb15-37"></a><span class="st">           </span>Date_Time <span class="op">&lt;</span><span class="st"> </span><span class="kw">as.POSIXct</span>(<span class="st">&quot;2020-10-31&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb15-38"><a href="#cb15-38"></a><span class="st">  </span><span class="co">## remove outliers identified in box plots under 1 foot depth</span></span>
<span id="cb15-39"><a href="#cb15-39"></a><span class="st">  </span><span class="kw">filter</span>(<span class="kw">as.numeric</span>(Depth) <span class="op">&lt;</span><span class="st"> </span><span class="dv">1</span> <span class="op">&amp;</span><span class="st"> </span><span class="kw">as.numeric</span>(Flow) <span class="op">&lt;</span><span class="st"> </span><span class="fl">4.3</span> <span class="op">|</span></span>
<span id="cb15-40"><a href="#cb15-40"></a><span class="st">           </span><span class="kw">as.numeric</span>(Depth) <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span></span>
<span id="cb15-41"><a href="#cb15-41"></a><span class="st">  </span><span class="kw">arrange</span>(Date_Time) <span class="op">%&gt;%</span></span>
<span id="cb15-42"><a href="#cb15-42"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">time_lag =</span> <span class="kw">lag</span>(Date_Time, <span class="dt">default =</span> Date_Time[<span class="dv">1</span>]),</span>
<span id="cb15-43"><a href="#cb15-43"></a>         <span class="dt">diff_time =</span> <span class="kw">as.numeric</span>(<span class="kw">difftime</span>(Date_Time, time_lag, <span class="dt">units =</span> <span class="st">&quot;hours&quot;</span>))) <span class="op">%&gt;%</span></span>
<span id="cb15-44"><a href="#cb15-44"></a><span class="st">  </span><span class="kw">group_split</span>(<span class="kw">cumsum</span>(diff_time <span class="op">&gt;</span><span class="st"> </span><span class="dv">8</span>)) <span class="op">%&gt;%</span></span>
<span id="cb15-45"><a href="#cb15-45"></a><span class="st">  </span><span class="co">## remove events where max flow did not go over 10 cfs</span></span>
<span id="cb15-46"><a href="#cb15-46"></a><span class="st">  </span><span class="kw">keep</span>(<span class="op">~</span><span class="st"> </span><span class="kw">max</span>(<span class="kw">as.numeric</span>(.x<span class="op">$</span>Flow)) <span class="op">&gt;</span><span class="st"> </span><span class="dv">10</span>) <span class="op">%&gt;%</span></span>
<span id="cb15-47"><a href="#cb15-47"></a><span class="st">  </span><span class="kw">map</span>(<span class="op">~</span><span class="kw">select</span>(.x, Date_Time, Depth, Flow)) <span class="op">%&gt;%</span></span>
<span id="cb15-48"><a href="#cb15-48"></a><span class="st">  </span><span class="kw">map</span>(<span class="op">~</span><span class="kw">mutate</span>(.x,</span>
<span id="cb15-49"><a href="#cb15-49"></a>              <span class="dt">time_lag =</span> <span class="kw">lag</span>(Date_Time, <span class="dt">default =</span> Date_Time[<span class="dv">1</span>]),</span>
<span id="cb15-50"><a href="#cb15-50"></a>              <span class="dt">diff_time =</span> <span class="kw">as.numeric</span>(<span class="kw">difftime</span>(Date_Time, time_lag, <span class="dt">units =</span> <span class="st">&quot;hours&quot;</span>)),</span>
<span id="cb15-51"><a href="#cb15-51"></a>              <span class="dt">diff_depth =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">diff</span>(.x<span class="op">$</span>Depth)))) <span class="op">%&gt;%</span></span>
<span id="cb15-52"><a href="#cb15-52"></a><span class="st">  </span><span class="kw">imap</span>(<span class="op">~</span><span class="kw">mutate</span>(.x, <span class="dt">event =</span> <span class="kw">as.character</span>(.y))) <span class="op">%&gt;%</span></span>
<span id="cb15-53"><a href="#cb15-53"></a><span class="st">  </span><span class="kw">bind_rows</span>() <span class="op">%&gt;%</span></span>
<span id="cb15-54"><a href="#cb15-54"></a><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(diff_depth)) <span class="op">%&gt;%</span></span>
<span id="cb15-55"><a href="#cb15-55"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">J =</span> <span class="kw">as.numeric</span>(diff_depth)<span class="op">/</span><span class="kw">as.numeric</span>(diff_time)) -&gt;<span class="st"> </span>df_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">06</span></span>
<span id="cb15-56"><a href="#cb15-56"></a></span>
<span id="cb15-57"><a href="#cb15-57"></a></span>
<span id="cb15-58"><a href="#cb15-58"></a>iqplus_df <span class="op">%&gt;%</span></span>
<span id="cb15-59"><a href="#cb15-59"></a><span class="st">  </span><span class="kw">filter</span>(Site <span class="op">==</span><span class="st"> &quot;16882&quot;</span>,</span>
<span id="cb15-60"><a href="#cb15-60"></a>         System_Status <span class="op">==</span><span class="st"> </span><span class="dv">0</span>,</span>
<span id="cb15-61"><a href="#cb15-61"></a>         System_In_Water <span class="op">==</span><span class="st"> </span><span class="dv">100</span>,</span>
<span id="cb15-62"><a href="#cb15-62"></a>         <span class="kw">as.numeric</span>(Depth) <span class="op">&gt;=</span><span class="st"> </span><span class="fl">0.26</span>, <span class="co">## minimum operating depth</span></span>
<span id="cb15-63"><a href="#cb15-63"></a>         <span class="kw">as.numeric</span>(Flow) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span></span>
<span id="cb15-64"><a href="#cb15-64"></a><span class="st">    </span><span class="kw">filter</span>(Date_Time <span class="op">&gt;=</span><span class="st"> </span><span class="kw">as.POSIXct</span>(<span class="st">&quot;2020-11-01&quot;</span>) <span class="op">&amp;</span></span>
<span id="cb15-65"><a href="#cb15-65"></a><span class="st">           </span>Date_Time <span class="op">&lt;</span><span class="st"> </span><span class="kw">as.POSIXct</span>(<span class="st">&quot;2021-01-31&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb15-66"><a href="#cb15-66"></a><span class="st">  </span><span class="co">## remove outliers identified in box plots under 1 foot depth</span></span>
<span id="cb15-67"><a href="#cb15-67"></a><span class="st">  </span><span class="kw">filter</span>(<span class="kw">as.numeric</span>(Depth) <span class="op">&lt;</span><span class="st"> </span><span class="dv">1</span> <span class="op">&amp;</span><span class="st"> </span><span class="kw">as.numeric</span>(Flow) <span class="op">&lt;</span><span class="st"> </span><span class="fl">4.3</span> <span class="op">|</span></span>
<span id="cb15-68"><a href="#cb15-68"></a><span class="st">           </span><span class="kw">as.numeric</span>(Depth) <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span></span>
<span id="cb15-69"><a href="#cb15-69"></a><span class="st">  </span><span class="kw">arrange</span>(Date_Time) <span class="op">%&gt;%</span></span>
<span id="cb15-70"><a href="#cb15-70"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">time_lag =</span> <span class="kw">lag</span>(Date_Time, <span class="dt">default =</span> Date_Time[<span class="dv">1</span>]),</span>
<span id="cb15-71"><a href="#cb15-71"></a>         <span class="dt">diff_time =</span> <span class="kw">as.numeric</span>(<span class="kw">difftime</span>(Date_Time, time_lag, <span class="dt">units =</span> <span class="st">&quot;hours&quot;</span>))) <span class="op">%&gt;%</span></span>
<span id="cb15-72"><a href="#cb15-72"></a><span class="st">  </span><span class="kw">group_split</span>(<span class="kw">cumsum</span>(diff_time <span class="op">&gt;</span><span class="st"> </span><span class="dv">8</span>)) <span class="op">%&gt;%</span></span>
<span id="cb15-73"><a href="#cb15-73"></a><span class="st">  </span><span class="co">## remove events where max flow did not go over 10 cfs</span></span>
<span id="cb15-74"><a href="#cb15-74"></a><span class="st">  </span><span class="kw">keep</span>(<span class="op">~</span><span class="st"> </span><span class="kw">max</span>(<span class="kw">as.numeric</span>(.x<span class="op">$</span>Flow)) <span class="op">&gt;</span><span class="st"> </span><span class="dv">10</span>) <span class="op">%&gt;%</span></span>
<span id="cb15-75"><a href="#cb15-75"></a><span class="st">  </span><span class="kw">map</span>(<span class="op">~</span><span class="kw">select</span>(.x, Date_Time, Depth, Flow)) <span class="op">%&gt;%</span></span>
<span id="cb15-76"><a href="#cb15-76"></a><span class="st">  </span><span class="kw">map</span>(<span class="op">~</span><span class="kw">mutate</span>(.x,</span>
<span id="cb15-77"><a href="#cb15-77"></a>              <span class="dt">time_lag =</span> <span class="kw">lag</span>(Date_Time, <span class="dt">default =</span> Date_Time[<span class="dv">1</span>]),</span>
<span id="cb15-78"><a href="#cb15-78"></a>              <span class="dt">diff_time =</span> <span class="kw">as.numeric</span>(<span class="kw">difftime</span>(Date_Time, time_lag, <span class="dt">units =</span> <span class="st">&quot;hours&quot;</span>)),</span>
<span id="cb15-79"><a href="#cb15-79"></a>              <span class="dt">diff_depth =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">diff</span>(.x<span class="op">$</span>Depth)))) <span class="op">%&gt;%</span></span>
<span id="cb15-80"><a href="#cb15-80"></a><span class="st">  </span><span class="kw">imap</span>(<span class="op">~</span><span class="kw">mutate</span>(.x, <span class="dt">event =</span> <span class="kw">as.character</span>(.y))) <span class="op">%&gt;%</span></span>
<span id="cb15-81"><a href="#cb15-81"></a><span class="st">  </span><span class="kw">bind_rows</span>() <span class="op">%&gt;%</span></span>
<span id="cb15-82"><a href="#cb15-82"></a><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(diff_depth)) <span class="op">%&gt;%</span></span>
<span id="cb15-83"><a href="#cb15-83"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">J =</span> <span class="kw">as.numeric</span>(diff_depth)<span class="op">/</span><span class="kw">as.numeric</span>(diff_time)) -&gt;<span class="st"> </span>df_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">11</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="co">## estimate parameters for each dataset</span></span>
<span id="cb16-2"><a href="#cb16-2"></a>SSE &lt;-<span class="st"> </span><span class="cf">function</span>(pars, data) {</span>
<span id="cb16-3"><a href="#cb16-3"></a>  Depth =<span class="st"> </span><span class="kw">as.numeric</span>(data<span class="op">$</span>Depth)</span>
<span id="cb16-4"><a href="#cb16-4"></a>  J =<span class="st"> </span>data<span class="op">$</span>J</span>
<span id="cb16-5"><a href="#cb16-5"></a>  K =<span class="st"> </span>pars[<span class="dv">1</span>]</span>
<span id="cb16-6"><a href="#cb16-6"></a>  a =<span class="st"> </span>pars[<span class="dv">2</span>]</span>
<span id="cb16-7"><a href="#cb16-7"></a>  n =<span class="st"> </span>pars[<span class="dv">3</span>]</span>
<span id="cb16-8"><a href="#cb16-8"></a>  x =<span class="st"> </span>pars[<span class="dv">4</span>]</span>
<span id="cb16-9"><a href="#cb16-9"></a></span>
<span id="cb16-10"><a href="#cb16-10"></a>  </span>
<span id="cb16-11"><a href="#cb16-11"></a>  preds &lt;-<span class="st"> </span>(K<span class="op">*</span><span class="kw">exponent</span>(<span class="dt">x =</span> Depth <span class="op">-</span><span class="st"> </span>a, <span class="dt">pow =</span> n)) <span class="op">*</span><span class="st"> </span><span class="kw">exponent</span>(<span class="dt">x =</span> (<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>x <span class="op">*</span><span class="st"> </span>J), <span class="dt">pow =</span> (<span class="dv">1</span><span class="op">/</span><span class="dv">2</span>))</span>
<span id="cb16-12"><a href="#cb16-12"></a>  <span class="co">#print(preds)</span></span>
<span id="cb16-13"><a href="#cb16-13"></a>  Q =<span class="st"> </span><span class="kw">as.numeric</span>(data<span class="op">$</span>Flow)</span>
<span id="cb16-14"><a href="#cb16-14"></a>  </span>
<span id="cb16-15"><a href="#cb16-15"></a>  <span class="co">## minimize the sum of square errors per the paper</span></span>
<span id="cb16-16"><a href="#cb16-16"></a>  sse &lt;-<span class="st"> </span><span class="kw">sum</span>((Q <span class="op">-</span><span class="st"> </span>preds)<span class="op">^</span><span class="dv">2</span>, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</span>
<span id="cb16-17"><a href="#cb16-17"></a>  <span class="co">#print(sse)</span></span>
<span id="cb16-18"><a href="#cb16-18"></a>  sse</span>
<span id="cb16-19"><a href="#cb16-19"></a>}</span>
<span id="cb16-20"><a href="#cb16-20"></a></span>
<span id="cb16-21"><a href="#cb16-21"></a>par &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">K =</span> <span class="dv">30</span>,</span>
<span id="cb16-22"><a href="#cb16-22"></a>         <span class="dt">a =</span> <span class="dv">1</span>,</span>
<span id="cb16-23"><a href="#cb16-23"></a>         <span class="dt">n =</span> <span class="dv">2</span>,</span>
<span id="cb16-24"><a href="#cb16-24"></a>         <span class="dt">x =</span> <span class="dv">1</span>)</span>
<span id="cb16-25"><a href="#cb16-25"></a></span>
<span id="cb16-26"><a href="#cb16-26"></a><span class="co">## limits to the parameter space</span></span>
<span id="cb16-27"><a href="#cb16-27"></a>lower &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="op">-</span><span class="dv">30</span>, <span class="fl">0.1</span>, <span class="dv">-20</span>, <span class="dv">-10</span>)</span>
<span id="cb16-28"><a href="#cb16-28"></a>upper &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">200</span>, <span class="dv">10</span>, <span class="dv">10</span>, <span class="dv">10</span>)</span>
<span id="cb16-29"><a href="#cb16-29"></a></span>
<span id="cb16-30"><a href="#cb16-30"></a>optim_par_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">03</span> &lt;-<span class="st"> </span><span class="kw">optim</span>(<span class="dt">par =</span> par,</span>
<span id="cb16-31"><a href="#cb16-31"></a>                   <span class="dt">fn =</span> SSE,</span>
<span id="cb16-32"><a href="#cb16-32"></a>                   <span class="dt">data =</span> df_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">03</span>,</span>
<span id="cb16-33"><a href="#cb16-33"></a>                   <span class="dt">lower =</span> lower,</span>
<span id="cb16-34"><a href="#cb16-34"></a>                   <span class="dt">upper =</span> upper,</span>
<span id="cb16-35"><a href="#cb16-35"></a>                   <span class="dt">method =</span> <span class="st">&quot;L-BFGS-B&quot;</span>)</span>
<span id="cb16-36"><a href="#cb16-36"></a></span>
<span id="cb16-37"><a href="#cb16-37"></a><span class="co">## starting estimates need some tweaking for the third season</span></span>
<span id="cb16-38"><a href="#cb16-38"></a>par &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">K =</span> <span class="dv">5</span>,</span>
<span id="cb16-39"><a href="#cb16-39"></a>         <span class="dt">a =</span> <span class="dv">5</span>,</span>
<span id="cb16-40"><a href="#cb16-40"></a>         <span class="dt">n =</span> <span class="dv">2</span>,</span>
<span id="cb16-41"><a href="#cb16-41"></a>         <span class="dt">x =</span> <span class="dv">1</span>)</span>
<span id="cb16-42"><a href="#cb16-42"></a></span>
<span id="cb16-43"><a href="#cb16-43"></a><span class="co">## limits to the parameter space</span></span>
<span id="cb16-44"><a href="#cb16-44"></a>lower &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="fl">0.1</span>, <span class="fl">0.00001</span>, <span class="fl">0.00001</span>, <span class="dv">-10</span>)</span>
<span id="cb16-45"><a href="#cb16-45"></a>upper &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">200</span>, <span class="dv">10</span>, <span class="dv">10</span>, <span class="dv">10</span>)</span>
<span id="cb16-46"><a href="#cb16-46"></a></span>
<span id="cb16-47"><a href="#cb16-47"></a>optim_par_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">06</span> &lt;-<span class="st"> </span><span class="kw">optim</span>(<span class="dt">par =</span> par,</span>
<span id="cb16-48"><a href="#cb16-48"></a>                   <span class="dt">fn =</span> SSE,</span>
<span id="cb16-49"><a href="#cb16-49"></a>                   <span class="dt">data =</span> df_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">06</span>,</span>
<span id="cb16-50"><a href="#cb16-50"></a>                   <span class="dt">lower =</span> lower,</span>
<span id="cb16-51"><a href="#cb16-51"></a>                   <span class="dt">upper =</span> upper,</span>
<span id="cb16-52"><a href="#cb16-52"></a>                   <span class="dt">method =</span> <span class="st">&quot;L-BFGS-B&quot;</span>)</span>
<span id="cb16-53"><a href="#cb16-53"></a></span>
<span id="cb16-54"><a href="#cb16-54"></a><span class="co">## starting estimates need some tweaking for the third season</span></span>
<span id="cb16-55"><a href="#cb16-55"></a>par &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">K =</span> <span class="dv">8</span>,</span>
<span id="cb16-56"><a href="#cb16-56"></a>         <span class="dt">a =</span> <span class="dv">1</span>,</span>
<span id="cb16-57"><a href="#cb16-57"></a>         <span class="dt">n =</span> <span class="dv">2</span>,</span>
<span id="cb16-58"><a href="#cb16-58"></a>         <span class="dt">x =</span> <span class="dv">1</span>)</span>
<span id="cb16-59"><a href="#cb16-59"></a></span>
<span id="cb16-60"><a href="#cb16-60"></a><span class="co">## limits to the parameter space</span></span>
<span id="cb16-61"><a href="#cb16-61"></a>lower &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="fl">0.1</span>, <span class="fl">0.00001</span>, <span class="fl">0.00001</span>, <span class="dv">-10</span>)</span>
<span id="cb16-62"><a href="#cb16-62"></a>upper &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">200</span>, <span class="dv">10</span>, <span class="dv">10</span>, <span class="dv">10</span>)</span>
<span id="cb16-63"><a href="#cb16-63"></a></span>
<span id="cb16-64"><a href="#cb16-64"></a>optim_par_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">11</span> &lt;-<span class="st"> </span><span class="kw">optim</span>(<span class="dt">par =</span> par,</span>
<span id="cb16-65"><a href="#cb16-65"></a>                   <span class="dt">fn =</span> SSE,</span>
<span id="cb16-66"><a href="#cb16-66"></a>                   <span class="dt">data =</span> df_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">11</span>,</span>
<span id="cb16-67"><a href="#cb16-67"></a>                   <span class="dt">lower =</span> lower,</span>
<span id="cb16-68"><a href="#cb16-68"></a>                   <span class="dt">upper =</span> upper,</span>
<span id="cb16-69"><a href="#cb16-69"></a>                   <span class="dt">method =</span> <span class="st">&quot;L-BFGS-B&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a><span class="co">## setup dataframe with parameter results. Will use this later to report parameters and GOF metrics</span></span>
<span id="cb17-2"><a href="#cb17-2"></a>df_results_<span class="dv">16882</span> &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">Site =</span> <span class="kw">c</span>(<span class="st">&quot;16882&quot;</span>,<span class="st">&quot;16882&quot;</span>,<span class="st">&quot;16882&quot;</span>),</span>
<span id="cb17-3"><a href="#cb17-3"></a>                           <span class="dt">Period =</span> <span class="kw">c</span>(<span class="st">&quot;2020-03-01 : 2020-05-31&quot;</span>,</span>
<span id="cb17-4"><a href="#cb17-4"></a>                                      <span class="st">&quot;2020-06-01 : 2020-10-31&quot;</span>,</span>
<span id="cb17-5"><a href="#cb17-5"></a>                                      <span class="st">&quot;2020-11-01 : 2021-01-31&quot;</span>),</span>
<span id="cb17-6"><a href="#cb17-6"></a>                           <span class="dt">K =</span> <span class="kw">c</span>(optim_par_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">03</span><span class="op">$</span>par[[<span class="dv">1</span>]],</span>
<span id="cb17-7"><a href="#cb17-7"></a>                                 optim_par_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">06</span><span class="op">$</span>par[[<span class="dv">1</span>]],</span>
<span id="cb17-8"><a href="#cb17-8"></a>                                 optim_par_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">11</span><span class="op">$</span>par[[<span class="dv">1</span>]]),</span>
<span id="cb17-9"><a href="#cb17-9"></a>                           <span class="dt">a =</span> <span class="kw">c</span>(optim_par_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">03</span><span class="op">$</span>par[[<span class="dv">2</span>]],</span>
<span id="cb17-10"><a href="#cb17-10"></a>                                 optim_par_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">06</span><span class="op">$</span>par[[<span class="dv">2</span>]],</span>
<span id="cb17-11"><a href="#cb17-11"></a>                                 optim_par_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">11</span><span class="op">$</span>par[[<span class="dv">2</span>]]),</span>
<span id="cb17-12"><a href="#cb17-12"></a>                           <span class="dt">n =</span> <span class="kw">c</span>(optim_par_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">03</span><span class="op">$</span>par[[<span class="dv">3</span>]],</span>
<span id="cb17-13"><a href="#cb17-13"></a>                                 optim_par_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">06</span><span class="op">$</span>par[[<span class="dv">3</span>]],</span>
<span id="cb17-14"><a href="#cb17-14"></a>                                 optim_par_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">11</span><span class="op">$</span>par[[<span class="dv">3</span>]]),</span>
<span id="cb17-15"><a href="#cb17-15"></a>                           <span class="dt">x =</span> <span class="kw">c</span>(optim_par_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">03</span><span class="op">$</span>par[[<span class="dv">4</span>]],</span>
<span id="cb17-16"><a href="#cb17-16"></a>                                 optim_par_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">06</span><span class="op">$</span>par[[<span class="dv">4</span>]],</span>
<span id="cb17-17"><a href="#cb17-17"></a>                                 optim_par_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">11</span><span class="op">$</span>par[[<span class="dv">4</span>]]))</span>
<span id="cb17-18"><a href="#cb17-18"></a></span>
<span id="cb17-19"><a href="#cb17-19"></a><span class="co">## Develop rating curve predictions and</span></span>
<span id="cb17-20"><a href="#cb17-20"></a><span class="co">## create table with GOF metrics</span></span>
<span id="cb17-21"><a href="#cb17-21"></a>df_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">03</span> <span class="op">%&gt;%</span></span>
<span id="cb17-22"><a href="#cb17-22"></a><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">predicted =</span> (df_results_<span class="dv">16882</span><span class="op">$</span>K[<span class="dv">1</span>]<span class="op">*</span><span class="kw">exponent</span>(<span class="dt">x =</span> <span class="kw">as.numeric</span>(Depth) <span class="op">-</span><span class="st"> </span>df_results_<span class="dv">16882</span><span class="op">$</span>a[<span class="dv">1</span>], <span class="dt">pow =</span> df_results_<span class="dv">16882</span><span class="op">$</span>n[<span class="dv">1</span>])) <span class="op">*</span><span class="st"> </span><span class="kw">exponent</span>(<span class="dt">x =</span> (<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>df_results_<span class="dv">16882</span><span class="op">$</span>x[<span class="dv">1</span>] <span class="op">*</span><span class="st"> </span>J), <span class="dt">pow =</span> (<span class="dv">1</span><span class="op">/</span><span class="dv">2</span>))) -&gt;<span class="st"> </span>df_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">03</span></span>
<span id="cb17-23"><a href="#cb17-23"></a></span>
<span id="cb17-24"><a href="#cb17-24"></a>df_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">06</span> <span class="op">%&gt;%</span></span>
<span id="cb17-25"><a href="#cb17-25"></a><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">predicted =</span> (df_results_<span class="dv">16882</span><span class="op">$</span>K[<span class="dv">2</span>]<span class="op">*</span><span class="kw">exponent</span>(<span class="dt">x =</span> <span class="kw">as.numeric</span>(Depth) <span class="op">-</span><span class="st"> </span>df_results_<span class="dv">16882</span><span class="op">$</span>a[<span class="dv">2</span>], <span class="dt">pow =</span> df_results_<span class="dv">16882</span><span class="op">$</span>n[<span class="dv">2</span>])) <span class="op">*</span><span class="st"> </span><span class="kw">exponent</span>(<span class="dt">x =</span> (<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>df_results_<span class="dv">16882</span><span class="op">$</span>x[<span class="dv">2</span>] <span class="op">*</span><span class="st"> </span>J), <span class="dt">pow =</span> (<span class="dv">1</span><span class="op">/</span><span class="dv">2</span>))) -&gt;<span class="st"> </span>df_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">06</span></span>
<span id="cb17-26"><a href="#cb17-26"></a></span>
<span id="cb17-27"><a href="#cb17-27"></a>df_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">11</span> <span class="op">%&gt;%</span></span>
<span id="cb17-28"><a href="#cb17-28"></a><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">predicted =</span> (df_results_<span class="dv">16882</span><span class="op">$</span>K[<span class="dv">3</span>]<span class="op">*</span><span class="kw">exponent</span>(<span class="dt">x =</span> <span class="kw">as.numeric</span>(Depth) <span class="op">-</span><span class="st"> </span>df_results_<span class="dv">16882</span><span class="op">$</span>a[<span class="dv">3</span>], <span class="dt">pow =</span> df_results_<span class="dv">16882</span><span class="op">$</span>n[<span class="dv">3</span>])) <span class="op">*</span><span class="st"> </span><span class="kw">exponent</span>(<span class="dt">x =</span> (<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>df_results_<span class="dv">16882</span><span class="op">$</span>x[<span class="dv">3</span>] <span class="op">*</span><span class="st"> </span>J), <span class="dt">pow =</span> (<span class="dv">1</span><span class="op">/</span><span class="dv">2</span>))) -&gt;<span class="st"> </span>df_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">11</span></span>
<span id="cb17-29"><a href="#cb17-29"></a></span>
<span id="cb17-30"><a href="#cb17-30"></a></span>
<span id="cb17-31"><a href="#cb17-31"></a>df_results_<span class="dv">16882</span> <span class="op">%&gt;%</span></span>
<span id="cb17-32"><a href="#cb17-32"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">NSE =</span> <span class="kw">c</span>(</span>
<span id="cb17-33"><a href="#cb17-33"></a>    hydroGOF<span class="op">::</span><span class="kw">NSE</span>(df_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">03</span><span class="op">$</span>predicted, <span class="kw">as.numeric</span>(df_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">03</span><span class="op">$</span>Flow)),</span>
<span id="cb17-34"><a href="#cb17-34"></a>    hydroGOF<span class="op">::</span><span class="kw">NSE</span>(df_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">06</span><span class="op">$</span>predicted, <span class="kw">as.numeric</span>(df_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">06</span><span class="op">$</span>Flow)),</span>
<span id="cb17-35"><a href="#cb17-35"></a>    hydroGOF<span class="op">::</span><span class="kw">NSE</span>(df_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">11</span><span class="op">$</span>predicted, <span class="kw">as.numeric</span>(df_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">11</span><span class="op">$</span>Flow))),</span>
<span id="cb17-36"><a href="#cb17-36"></a>    <span class="dt">nRMSE =</span> <span class="kw">c</span>(hydroGOF<span class="op">::</span><span class="kw">nrmse</span>(df_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">03</span><span class="op">$</span>predicted, <span class="kw">as.numeric</span>(df_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">03</span><span class="op">$</span>Flow), <span class="dt">norm =</span> <span class="st">&quot;maxmin&quot;</span>),</span>
<span id="cb17-37"><a href="#cb17-37"></a>              hydroGOF<span class="op">::</span><span class="kw">nrmse</span>(df_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">06</span><span class="op">$</span>predicted, <span class="kw">as.numeric</span>(df_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">06</span><span class="op">$</span>Flow), <span class="dt">norm =</span> <span class="st">&quot;maxmin&quot;</span>),</span>
<span id="cb17-38"><a href="#cb17-38"></a>              hydroGOF<span class="op">::</span><span class="kw">nrmse</span>(df_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">11</span><span class="op">$</span>predicted, <span class="kw">as.numeric</span>(df_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">11</span><span class="op">$</span>Flow), <span class="dt">norm =</span> <span class="st">&quot;maxmin&quot;</span>))</span>
<span id="cb17-39"><a href="#cb17-39"></a>    ) -&gt;<span class="st"> </span>df_results_<span class="dv">16882</span></span>
<span id="cb17-40"><a href="#cb17-40"></a></span>
<span id="cb17-41"><a href="#cb17-41"></a><span class="co">##display table</span></span>
<span id="cb17-42"><a href="#cb17-42"></a><span class="kw">kable</span>(df_results_<span class="dv">16882</span>, </span>
<span id="cb17-43"><a href="#cb17-43"></a>      <span class="dt">caption =</span> <span class="st">&quot;Rating curve parameter estimates and goodness-of-fit metrics for station 16882.&quot;</span>) </span></code></pre></div>
<table>
<caption><span id="tab:results16882">Table 3: </span>Rating curve parameter estimates and goodness-of-fit metrics for station 16882.</caption>
<colgroup>
<col width="6%" />
<col width="26%" />
<col width="12%" />
<col width="10%" />
<col width="12%" />
<col width="13%" />
<col width="12%" />
<col width="6%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">Site</th>
<th align="left">Period</th>
<th align="right">K</th>
<th align="right">a</th>
<th align="right">n</th>
<th align="right">x</th>
<th align="right">NSE</th>
<th align="right">nRMSE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">16882</td>
<td align="left">2020-03-01 : 2020-05-31</td>
<td align="right">-30.000000</td>
<td align="right">10.00000</td>
<td align="right">-20.000000</td>
<td align="right">-10.0000000</td>
<td align="right">-0.7363925</td>
<td align="right">33.4</td>
</tr>
<tr class="even">
<td align="left">16882</td>
<td align="left">2020-06-01 : 2020-10-31</td>
<td align="right">6.939952</td>
<td align="right">1.66193</td>
<td align="right">1.374969</td>
<td align="right">-0.6751434</td>
<td align="right">0.0430754</td>
<td align="right">4.3</td>
</tr>
<tr class="odd">
<td align="left">16882</td>
<td align="left">2020-11-01 : 2021-01-31</td>
<td align="right">0.100000</td>
<td align="right">5.40777</td>
<td align="right">0.000010</td>
<td align="right">-10.0000000</td>
<td align="right">-0.8549177</td>
<td align="right">4.3</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a><span class="co">## plot rating curve results</span></span>
<span id="cb18-2"><a href="#cb18-2"></a>df_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">03</span> <span class="op">%&gt;%</span></span>
<span id="cb18-3"><a href="#cb18-3"></a><span class="st">  </span><span class="kw">bind_rows</span>(df_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">06</span>, df_<span class="dv">16882</span>_<span class="dv">2020</span>_<span class="dv">11</span>) <span class="op">%&gt;%</span></span>
<span id="cb18-4"><a href="#cb18-4"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">predicted =</span> <span class="kw">set_units</span>(predicted, <span class="st">&quot;ft^3/s&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb18-5"><a href="#cb18-5"></a><span class="st">  </span><span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb18-6"><a href="#cb18-6"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="kw">as.numeric</span>(predicted), <span class="kw">as.numeric</span>(Flow), <span class="dt">color =</span> <span class="st">&quot;Rating curve prediction against measured flow&quot;</span>), <span class="dt">alpha =</span> <span class="fl">0.25</span>) <span class="op">+</span></span>
<span id="cb18-7"><a href="#cb18-7"></a><span class="st">  </span><span class="kw">geom_abline</span>(<span class="kw">aes</span>(<span class="dt">slope =</span> <span class="dv">1</span>, <span class="dt">intercept =</span> <span class="dv">0</span>, <span class="dt">linetype =</span> <span class="st">&quot;1:1 line&quot;</span>)) <span class="op">+</span></span>
<span id="cb18-8"><a href="#cb18-8"></a><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">name =</span> <span class="st">&quot;Rating curve flow estimate [cfs]&quot;</span>, <span class="dt">trans =</span> <span class="st">&quot;log10&quot;</span>) <span class="op">+</span></span>
<span id="cb18-9"><a href="#cb18-9"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">name =</span> <span class="st">&quot;Measured flow [cfs]&quot;</span>, <span class="dt">trans =</span> <span class="st">&quot;log10&quot;</span>) <span class="op">+</span></span>
<span id="cb18-10"><a href="#cb18-10"></a><span class="st">  </span><span class="kw">theme_ms</span>() <span class="op">+</span></span>
<span id="cb18-11"><a href="#cb18-11"></a><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.title =</span> <span class="kw">element_blank</span>())</span></code></pre></div>
<pre><code>## Warning in self$trans$transform(x): NaNs produced</code></pre>
<pre><code>## Warning: Transformation introduced infinite values in continuous x-axis</code></pre>
<pre><code>## Warning: Removed 7864 rows containing missing values (geom_point).</code></pre>
<div class="figure"><span id="fig:metricplot16882"></span>
<img src="document_files/figure-html/metricplot16882-1.png" alt="Scatter plot of rating curve estimated flows against measured flows at station 16882" width="672" />
<p class="caption">
Figure 3: Scatter plot of rating curve estimated flows against measured flows at station 16882
</p>
</div>

<div id="refs" class="references">
<div id="ref-petersen-overleir_modelling_2006">
<p>Petersen-Øverleir, Asgeir. 2006. “Modelling Stage—Discharge Relationships Affected by Hysteresis Using the Jones Formula and Nonlinear Regression.” <em>Hydrological Sciences Journal</em> 51 (3): 365–88. <a href="https://doi.org/10.1623/hysj.51.3.365">https://doi.org/10.1623/hysj.51.3.365</a>.</p>
</div>
<div id="ref-venetis1970note">
<p>Venetis, C. 1970. “A Note on the Estimation of the Parameters in Logarithmic Stage-Discharge Relationships with Estimates of Their Error.” <em>Hydrological Sciences Journal</em> 15 (2): 105–11.</p>
</div>
<div id="ref-zakwan_spreadsheet-based_2018">
<p>Zakwan, Mohammad. 2018. “Spreadsheet-Based Modelling of Hysteresis-Affected Curves.” <em>Applied Water Science</em> 8 (4): 101. <a href="https://doi.org/10.1007/s13201-018-0745-3">https://doi.org/10.1007/s13201-018-0745-3</a>.</p>
</div>
</div>
</div>
</div>

<center>
  <div class="footer">
<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" /></a><br />Text and figures are licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a> unless otherwise indicated.
  </div>
</center>
            </section>

          </div>
        </div>
      </div>


    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/mps9506/thompson-stage-discharge/edit/main/%s",
"text": "Suggest an edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["https://github.com/mps9506/thompson-stage-discharge/raw/main/%s"],
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
